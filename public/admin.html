<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel RH - Vale-G√°s</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #053462;
            --primary-light: #0a4a8a;
            --primary-dark: #032544;
            --accent: #DC3E31;
            --accent-light: #e85a4f;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            /* Tema claro (padr√£o) */
            --bg-body: #f9fafb;
            --bg-card: #ffffff;
            --bg-sidebar: #ffffff;
            --bg-input: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow-color: rgba(0,0,0,0.1);
        }
        
        /* Tema Escuro */
        [data-theme="dark"] {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-sidebar: #1e293b;
            --bg-input: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --shadow-color: rgba(0,0,0,0.3);
            --gray-50: #1e293b;
            --gray-100: #334155;
            --gray-200: #475569;
            --gray-400: #94a3b8;
            --gray-500: #94a3b8;
            --gray-600: #cbd5e1;
            --gray-700: #cbd5e1;
            --gray-800: #e2e8f0;
            --gray-900: #f1f5f9;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-body); color: var(--text-primary); line-height: 1.5; transition: background 0.3s, color 0.3s; }
        
        /* Navbar */
        .navbar { background: var(--primary); color: white; padding: 0 24px; height: 64px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 3px var(--shadow-color); }
        .navbar-brand { display: flex; align-items: center; gap: 12px; font-weight: 600; font-size: 18px; }
        .navbar-brand svg { width: 32px; height: 32px; }
        .navbar-user { display: flex; align-items: center; gap: 16px; }
        .navbar-user span { font-size: 14px; opacity: 0.9; }
        .btn-logout { background: rgba(255,255,255,0.15); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: background 0.2s; }
        .btn-logout:hover { background: rgba(255,255,255,0.25); }
        
        /* Toggle Tema */
        .theme-toggle { background: rgba(255,255,255,0.15); border: none; padding: 8px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .theme-toggle:hover { background: rgba(255,255,255,0.25); }
        .theme-toggle svg { width: 20px; height: 20px; stroke: white; fill: none; }

        /* Layout */
        .layout { display: flex; min-height: calc(100vh - 64px); }
        
        /* Sidebar */
        .sidebar { width: 240px; background: var(--bg-sidebar); border-right: 1px solid var(--border-color); padding: 16px 0; transition: width 0.3s ease, background 0.3s, border-color 0.3s; overflow: hidden; }
        .sidebar.collapsed { width: 64px; }
        .sidebar-menu { list-style: none; }
        .sidebar-menu a { display: flex; align-items: center; gap: 12px; padding: 12px 24px; color: var(--text-secondary); text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.2s; border-left: 3px solid transparent; white-space: nowrap; }
        .sidebar.collapsed .sidebar-menu a { padding: 12px 20px; justify-content: center; }
        .sidebar.collapsed .sidebar-menu a span { display: none; }
        .sidebar-menu a:hover { background: var(--gray-100); color: var(--text-primary); }
        .sidebar-menu a.active { background: rgba(5, 52, 98, 0.15); color: var(--primary); border-left-color: var(--primary); }
        [data-theme="dark"] .sidebar-menu a.active { background: rgba(59, 130, 246, 0.15); color: #60a5fa; border-left-color: #60a5fa; }
        .sidebar-menu svg { width: 20px; height: 20px; opacity: 0.7; flex-shrink: 0; }

        /* Toggle Sidebar Button */
        .sidebar-toggle { display: flex; align-items: center; justify-content: flex-end; padding: 8px 16px; margin-bottom: 8px; }
        .sidebar.collapsed .sidebar-toggle { justify-content: center; padding: 8px; }
        .btn-toggle-sidebar { background: var(--gray-100); border: none; padding: 8px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .btn-toggle-sidebar:hover { background: var(--gray-200); }
        .btn-toggle-sidebar svg { width: 18px; height: 18px; color: var(--text-secondary); transition: transform 0.3s; }
        .sidebar.collapsed .btn-toggle-sidebar svg { transform: rotate(180deg); }

        /* Main */
        .main { flex: 1; padding: 24px; overflow-x: auto; }
        .page-title { font-size: 24px; font-weight: 600; color: var(--text-primary); margin-bottom: 24px; }

        /* Cards */
        .card { background: var(--bg-card); border-radius: 12px; box-shadow: 0 1px 3px var(--shadow-color); padding: 24px; margin-bottom: 24px; border: 1px solid var(--border-color); transition: background 0.3s, border-color 0.3s; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color); }
        .card-title { font-size: 16px; font-weight: 600; color: var(--text-primary); }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-card); border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px var(--shadow-color); border: 1px solid var(--border-color); transition: background 0.3s, border-color 0.3s; display: flex; align-items: center; gap: 16px; }
        .stat-card-icon { width: 48px; height: 48px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-bottom: 12px; }
        .stat-card-icon.blue { background: rgba(5, 52, 98, 0.1); color: var(--primary); }
        .stat-card-icon.green { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .stat-card-icon.orange { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .stat-card-icon.red { background: rgba(220, 62, 49, 0.1); color: var(--accent); }
        .stat-card h3 { font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px; }
        .stat-card p { font-size: 13px; color: var(--text-secondary); }
        .stat-icon { width: 60px; height: 60px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .stat-icon svg { width: 30px; height: 30px; }
        .stat-content { flex: 1; }
        .stat-label { font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 32px; font-weight: 700; color: var(--text-primary); margin-bottom: 2px; line-height: 1; }
        .stat-description { font-size: 12px; color: var(--text-secondary); }

        /* Buttons */
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-light); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-warning:hover { background: #d97706; }
        .btn-outline { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-outline:hover { background: var(--gray-100); }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .btn-icon { padding: 8px; }
        .btn-lg { padding: 14px 24px; font-size: 16px; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background: var(--gray-100); font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        td { font-size: 14px; color: var(--text-primary); }
        tr:hover { background: var(--gray-100); }
        .table-actions { display: flex; gap: 8px; }

        /* Badges */
        .badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .badge-success { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .badge-warning { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
        .badge-danger { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
        .badge-info { background: rgba(5, 52, 98, 0.1); color: #0a4a8a; }
        [data-theme="dark"] .badge-success { background: rgba(16, 185, 129, 0.2); }
        [data-theme="dark"] .badge-warning { background: rgba(245, 158, 11, 0.2); }
        [data-theme="dark"] .badge-danger { background: rgba(239, 68, 68, 0.2); }
        [data-theme="dark"] .badge-info { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }

        /* Forms */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; color: var(--text-primary); margin-bottom: 6px; }
        .form-control { width: 100%; padding: 10px 14px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; transition: border-color 0.2s, box-shadow 0.2s; background: var(--bg-input); color: var(--text-primary); }
        .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(5, 52, 98, 0.1); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .form-text { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }

        /* Search Bar */
        .search-bar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-input { flex: 1; min-width: 200px; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal.show { display: flex; }
        .modal-content { background: var(--bg-card); border-radius: 16px; width: 100%; max-width: 560px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border-color); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border-color); }
        .modal-title { font-size: 18px; font-weight: 600; color: var(--text-primary); }
        .modal-close { background: none; border: none; font-size: 24px; color: var(--text-secondary); cursor: pointer; padding: 4px; }
        .modal-close:hover { color: var(--text-primary); }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px; }

        /* Section visibility */
        .section { display: none; }
        .section.active { display: block; }

        /* Password display */
        .senha-box { background: var(--gray-100); border: 1px dashed var(--border-color); border-radius: 8px; padding: 12px 16px; margin-top: 8px; }
        .senha-box code { font-size: 16px; font-weight: 600; color: var(--primary); letter-spacing: 1px; }
        .senha-box small { display: block; margin-top: 4px; color: var(--text-secondary); font-size: 11px; }

        /* Empty state */
        .empty-state { text-align: center; padding: 48px 24px; color: var(--text-secondary); }
        .empty-state svg { width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.5; }
        .empty-state p { font-size: 14px; }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .form-row { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <img src="https://consigaz.zendesk.com/embeddable/avatars/7617583100308" alt="Consigaz" style="height:36px">
            <span style="margin-left:12px;border-left:1px solid rgba(255,255,255,0.3);padding-left:12px">Painel RH</span>
        </div>
        <div class="navbar-user">
            <span id="userName"></span>
            <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema">
                <svg id="iconSol" viewBox="0 0 24 24" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                <svg id="iconLua" viewBox="0 0 24 24" stroke-width="2" style="display:none"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
            </button>
            <button class="btn-logout" onclick="logout()">Sair</button>
        </div>
    </nav>

    <div class="layout">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-toggle">
                <button class="btn-toggle-sidebar" onclick="toggleSidebar()" title="Recolher/Expandir menu">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="11 17 6 12 11 7"/><polyline points="18 17 13 12 18 7"/></svg>
                </button>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#" class="active" data-section="dashboard"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg><span>Dashboard</span></a></li>
                <li><a href="#" data-section="colaboradores"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Colaboradores</span></a></li>
                <li><a href="#" data-section="distribuidores"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><span>Distribuidores</span></a></li>
                <li><a href="#" data-section="vales"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg><span>Vales-G√°s</span></a></li>
                <li><a href="#" data-section="reembolsos"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg><span>Reembolsos</span></a></li>
                <li><a href="#" data-section="solicitacoes"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M9 15l2 2 4-4"/></svg><span>Solicita√ß√µes</span></a></li>
                <li><a href="#" data-section="relatorios"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg><span>Relat√≥rios</span></a></li>
                <li id="menuUsuarios" style="display:none"><a href="#" data-section="usuarios"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a5 5 0 0 1 5 5v3H7V7a5 5 0 0 1 5-5z"/><rect x="3" y="10" width="18" height="12" rx="2"/><circle cx="12" cy="16" r="1"/></svg><span>Usu√°rios RH</span></a></li>
                <li id="menuNotificacoes" style="display:none"><a href="#" data-section="notificacoes"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg><span>Notifica√ß√µes</span></a></li>
                <li id="menuConfiguracoes" style="display:none"><a href="#" data-section="configuracoes"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg><span>Configura√ß√µes</span></a></li>
                <li id="menuAuditoria" style="display:none"><a href="#" data-section="auditoria"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg><span>Auditoria</span></a></li>
            </ul>
        </aside>

        <main class="main">
            <!-- Dashboard -->
            <div id="s-dashboard" class="section active">
                <h1 class="page-title">Dashboard</h1>
                <div id="statsGrid" class="stats-grid"></div>
                
                <!-- Se√ß√£o de Vales-G√°s -->
                <div style="margin-top:24px;margin-bottom:20px;display:flex;align-items:center;gap:12px">
                    <div style="width:40px;height:40px;background:linear-gradient(135deg,#053462 0%,#0a4a8a 100%);border-radius:10px;display:flex;align-items:center;justify-content:center">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                    </div>
                    <div>
                        <h2 style="font-size:18px;font-weight:600;color:var(--text-primary);margin:0">Vales-G√°s</h2>
                        <p style="font-size:12px;color:var(--text-secondary);margin:0">Acompanhamento de emiss√£o e utiliza√ß√£o de vales</p>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(380px, 1fr));gap:20px">
                    <!-- Gr√°fico de Retiradas por M√™s -->
                    <div class="card" style="border-top:3px solid #053462">
                        <div class="card-header" style="border-bottom:none;padding-bottom:0">
                            <div style="display:flex;align-items:center;gap:8px">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#053462" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                                <h3 class="card-title" style="margin:0">Retiradas Mensais</h3>
                            </div>
                            <span style="font-size:11px;background:rgba(5,52,98,0.1);padding:4px 8px;border-radius:12px;color:#053462;font-weight:500">6 meses</span>
                        </div>
                        <div style="padding:16px 20px;height:260px">
                            <canvas id="chartRetiradas"></canvas>
                        </div>
                    </div>

                    <!-- Gr√°fico de Status dos Vales -->
                    <div class="card" style="border-top:3px solid #8b5cf6">
                        <div class="card-header" style="border-bottom:none;padding-bottom:0">
                            <div style="display:flex;align-items:center;gap:8px">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                                <h3 class="card-title" style="margin:0">Status dos Vales</h3>
                            </div>
                            <span style="font-size:11px;background:rgba(139,92,246,0.1);padding:4px 8px;border-radius:12px;color:#8b5cf6;font-weight:500">M√™s atual</span>
                        </div>
                        <div style="padding:16px 20px;height:260px;display:flex;align-items:center;justify-content:center">
                            <canvas id="chartStatus" style="max-width:220px"></canvas>
                        </div>
                    </div>

                    <!-- Gr√°fico de Taxa de Utiliza√ß√£o -->
                    <div class="card" style="border-top:3px solid #06b6d4">
                        <div class="card-header" style="border-bottom:none;padding-bottom:0">
                            <div style="display:flex;align-items:center;gap:8px">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#06b6d4" stroke-width="2"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
                                <h3 class="card-title" style="margin:0">Taxa de Utiliza√ß√£o</h3>
                            </div>
                            <span style="font-size:11px;background:rgba(6,182,212,0.1);padding:4px 8px;border-radius:12px;color:#06b6d4;font-weight:500">%</span>
                        </div>
                        <div style="padding:16px 20px;height:260px">
                            <canvas id="chartTaxa"></canvas>
                        </div>
                    </div>

                    <!-- Top Distribuidores -->
                    <div class="card" style="border-top:3px solid #ec4899">
                        <div class="card-header" style="border-bottom:none;padding-bottom:0">
                            <div style="display:flex;align-items:center;gap:8px">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ec4899" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
                                <h3 class="card-title" style="margin:0">Top Distribuidores</h3>
                            </div>
                            <span style="font-size:11px;background:rgba(236,72,153,0.1);padding:4px 8px;border-radius:12px;color:#ec4899;font-weight:500">Top 5</span>
                        </div>
                        <div style="padding:16px 20px;height:260px">
                            <canvas id="chartDistribuidores"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Gr√°ficos de Reembolsos -->
                <!-- Se√ß√£o de Reembolsos -->
                <div style="margin-top:32px;margin-bottom:20px;display:flex;align-items:center;gap:12px">
                    <div style="width:40px;height:40px;background:linear-gradient(135deg,#DC3E31 0%,#b82e23 100%);border-radius:10px;display:flex;align-items:center;justify-content:center">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                    </div>
                    <div>
                        <h2 style="font-size:18px;font-weight:600;color:var(--text-primary);margin:0">Reembolsos</h2>
                        <p style="font-size:12px;color:var(--text-secondary);margin:0">Acompanhamento financeiro dos distribuidores externos</p>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(380px, 1fr));gap:20px">
                    <!-- Gr√°fico de Reembolsos por M√™s -->
                    <div class="card" style="border-top:3px solid #DC3E31">
                        <div class="card-header" style="border-bottom:none;padding-bottom:0">
                            <div style="display:flex;align-items:center;gap:8px">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#DC3E31" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                <h3 class="card-title" style="margin:0">Quantidade Mensal</h3>
                            </div>
                            <span style="font-size:11px;background:var(--gray-100);padding:4px 8px;border-radius:12px;color:var(--text-secondary)">√öltimos 6 meses</span>
                        </div>
                        <div style="padding:16px 20px;height:260px">
                            <canvas id="chartReembolsosMes"></canvas>
                        </div>
                    </div>

                    <!-- Gr√°fico de Status dos Reembolsos -->
                    <div class="card" style="border-top:3px solid #3b82f6">
                        <div class="card-header" style="border-bottom:none;padding-bottom:0">
                            <div style="display:flex;align-items:center;gap:8px">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                                <h3 class="card-title" style="margin:0">Status Atual</h3>
                            </div>
                            <span style="font-size:11px;background:var(--gray-100);padding:4px 8px;border-radius:12px;color:var(--text-secondary)">M√™s atual</span>
                        </div>
                        <div style="padding:16px 20px;height:260px;display:flex;align-items:center;justify-content:center">
                            <canvas id="chartReembolsosStatus" style="max-width:220px"></canvas>
                        </div>
                    </div>

                    <!-- Gr√°fico de Valores por M√™s -->
                    <div class="card" style="border-top:3px solid #10b981">
                        <div class="card-header" style="border-bottom:none;padding-bottom:0">
                            <div style="display:flex;align-items:center;gap:8px">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                                <h3 class="card-title" style="margin:0">Valores Mensais</h3>
                            </div>
                            <span style="font-size:11px;background:rgba(16,185,129,0.1);padding:4px 8px;border-radius:12px;color:#10b981;font-weight:500">R$ Total</span>
                        </div>
                        <div style="padding:16px 20px;height:260px">
                            <canvas id="chartReembolsosValor"></canvas>
                        </div>
                    </div>

                    <!-- Top Distribuidores por Reembolso -->
                    <div class="card" style="border-top:3px solid #f59e0b">
                        <div class="card-header" style="border-bottom:none;padding-bottom:0">
                            <div style="display:flex;align-items:center;gap:8px">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
                                <h3 class="card-title" style="margin:0">Ranking Distribuidores</h3>
                            </div>
                            <span style="font-size:11px;background:rgba(245,158,11,0.1);padding:4px 8px;border-radius:12px;color:#f59e0b;font-weight:500">Top 5</span>
                        </div>
                        <div style="padding:16px 20px;height:260px">
                            <canvas id="chartReembolsosDist"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Tabela de Retiradas por Distribuidor -->
                <div class="card" style="margin-top:20px">
                    <div class="card-header"><h3 class="card-title">Detalhes por Distribuidor (M√™s Atual)</h3></div>
                    <div id="chartDist"></div>
                </div>
            </div>

            <!-- Colaboradores -->
            <div id="s-colaboradores" class="section">
                <h1 class="page-title">Colaboradores</h1>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Lista de Colaboradores</h3>
                        <div style="display:flex;gap:8px">
                            <button class="btn btn-outline" onclick="abrirModalImportacao()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                Importar
                            </button>
                            <button class="btn btn-primary" onclick="openModal('colab')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                Novo Colaborador
                            </button>
                        </div>
                    </div>
                    <div class="search-bar">
                        <input type="text" id="searchColab" class="form-control search-input" placeholder="Buscar por nome, CPF, email...">
                        <select id="filterAtivo" class="form-control" style="width: auto;">
                            <option value="">Todos os status</option>
                            <option value="true">Apenas Ativos</option>
                            <option value="false">Apenas Inativos</option>
                        </select>
                        <button class="btn btn-outline" onclick="loadColabs()">Buscar</button>
                    </div>
                    <div id="tableColabs"></div>
                </div>
            </div>

            <!-- Distribuidores -->
            <div id="s-distribuidores" class="section">
                <h1 class="page-title">Distribuidores</h1>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Lista de Distribuidores</h3>
                        <div style="display:flex;gap:8px">
                            <button class="btn btn-success" onclick="abrirModalImportarDist()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Importar</button>
                            <button class="btn btn-primary" onclick="openModal('dist')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Novo Distribuidor</button>
                        </div>
                    </div>
                    <div class="search-bar">
                        <input type="text" id="searchDist" class="form-control search-input" placeholder="Buscar por nome, CNPJ, cidade...">
                        <button class="btn btn-outline" onclick="loadDists()">Buscar</button>
                    </div>
                    <div id="tableDists"></div>
                </div>
            </div>

            <!-- Vales -->
            <div id="s-vales" class="section">
                <h1 class="page-title">Vales-G√°s</h1>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Controle de Vales</h3>
                        <div style="display:flex;gap:8px;">
                            <button class="btn btn-primary" onclick="abrirModalGerarVales()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>Gerar Vales</button>
                        </div>
                    </div>
                    <div class="search-bar">
                        <input type="month" id="filterMes" class="form-control" style="width: auto;">
                        <select id="filterStatus" class="form-control" style="width: auto;">
                            <option value="">Todos os status</option>
                            <option value="ativo">Ativos</option>
                            <option value="utilizado">Utilizados</option>
                            <option value="expirado">Expirados</option>
                        </select>
                        <button class="btn btn-outline" onclick="loadVales()">Filtrar</button>
                    </div>
                    <div id="tableVales"></div>
                </div>
            </div>

            <!-- Reembolsos -->
            <div id="s-reembolsos" class="section">
                <h1 class="page-title">Gest√£o de Reembolsos</h1>

                <!-- Cards de Estat√≠sticas -->
                <div class="stats-grid" id="reembolsosStats">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">A Validar</div>
                            <div class="stat-value" id="reembolsos-a-validar">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Aprovados</div>
                            <div class="stat-value" id="reembolsos-aprovados">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Pagos</div>
                            <div class="stat-value" id="reembolsos-pagos">0</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Total Aprovado</div>
                            <div class="stat-value" id="reembolsos-total">R$ 0,00</div>
                        </div>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <h3 class="card-title">Filtros</h3>
                        <button class="btn btn-secondary btn-sm" onclick="limparFiltrosReembolsos()">Limpar</button>
                    </div>
                    <div class="search-bar" style="display:flex;flex-wrap:wrap;gap:12px;padding:16px">
                        <select id="filtro-status-reembolso" class="form-control" style="width:auto" onchange="loadReembolsos()">
                            <option value="">Todos os Status</option>
                            <option value="a_validar">A Validar</option>
                            <option value="aprovado">Aprovado</option>
                            <option value="pago">Pago</option>
                            <option value="rejeitado">Rejeitado</option>
                        </select>
                        <select id="filtro-distribuidor-reembolso" class="form-control" style="width:auto" onchange="loadReembolsos()">
                            <option value="">Todos Distribuidores</option>
                        </select>
                        <input type="month" id="filtro-mes-reembolso" class="form-control" style="width:auto" onchange="loadReembolsos()">
                        <button class="btn btn-outline" onclick="loadReembolsos()">Filtrar</button>
                    </div>
                </div>

                <!-- Tabela de Reembolsos -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Lista de Reembolsos</h3>
                        <div style="display:flex;gap:8px">
                            <button class="btn btn-success btn-sm" onclick="exportarReembolsosCSV()">Exportar CSV</button>
                            <button class="btn btn-primary btn-sm" onclick="abrirModalNovoReembolso()">Novo Reembolso</button>
                        </div>
                    </div>
                    <div id="tableReembolsos"></div>
                </div>
            </div>

            <!-- Solicita√ß√µes -->
            <div id="s-solicitacoes" class="section">
                <h1 class="page-title">Solicita√ß√µes</h1>
                <div class="card">
                    <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
                        <h3 class="card-title" style="margin:0;border:none;padding:0">Solicita√ß√µes de Altera√ß√£o</h3>
                        <div style="display:flex;gap:8px">
                            <button class="btn btn-sm btn-primary" onclick="loadSolic('pendente')" id="btnSolicPendente">Pendentes</button>
                            <button class="btn btn-sm btn-outline" onclick="loadSolic('aprovado')" id="btnSolicAprovado">Aprovadas</button>
                            <button class="btn btn-sm btn-outline" onclick="loadSolic('rejeitado')" id="btnSolicRejeitado">Rejeitadas</button>
                        </div>
                    </div>
                    <div id="tableSolic"></div>
                </div>
            </div>

            <!-- Relat√≥rios -->
            <div id="s-relatorios" class="section">
                <h1 class="page-title">Relat√≥rios</h1>
                
                <!-- Relat√≥rio de Retiradas -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìä Relat√≥rio de Retiradas</h3>
                    </div>
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label class="form-label">M√™s In√≠cio</label>
                            <input type="month" id="relIni" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">M√™s Fim</label>
                            <input type="month" id="relFim" class="form-control">
                        </div>
                        <div class="form-group" style="align-self:flex-end">
                            <button class="btn btn-primary" onclick="genReport()">Gerar Relat√≥rio</button>
                        </div>
                    </div>
                    <div id="reportOut" style="margin-top: 24px;"></div>
                    <div id="reportActions" style="display:none;margin-top:20px;padding-top:20px;border-top:1px solid var(--gray-200)">
                        <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Exportar relat√≥rio:</p>
                        <div style="display:flex;gap:12px">
                            <button class="btn btn-success" onclick="exportarRelatorioExcel()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                                Exportar Excel
                            </button>
                            <button class="btn btn-danger" onclick="exportarRelatorioPDF()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                                Exportar PDF
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Exportar Colaboradores -->
                <div class="card" style="margin-top:20px">
                    <div class="card-header">
                        <h3 class="card-title">üë• Exportar Lista de Colaboradores</h3>
                    </div>
                    <div class="form-row" style="margin-bottom:20px">
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select id="expColabStatus" class="form-control">
                                <option value="">Todos</option>
                                <option value="true">Apenas Ativos</option>
                                <option value="false">Apenas Inativos</option>
                            </select>
                        </div>
                    </div>
                    <div style="display:flex;gap:12px">
                        <button class="btn btn-success" onclick="exportarColaboradoresExcel()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                            Exportar Excel
                        </button>
                        <button class="btn btn-danger" onclick="exportarColaboradoresPDF()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                            Exportar PDF
                        </button>
                    </div>
                </div>

                <!-- Exportar Vales do M√™s -->
                <div class="card" style="margin-top:20px">
                    <div class="card-header">
                        <h3 class="card-title">üé´ Exportar Vales do M√™s</h3>
                    </div>
                    <div class="form-row" style="margin-bottom:20px">
                        <div class="form-group">
                            <label class="form-label">M√™s</label>
                            <input type="month" id="expValesMes" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select id="expValesStatus" class="form-control">
                                <option value="">Todos</option>
                                <option value="ativo">Ativos</option>
                                <option value="utilizado">Utilizados</option>
                                <option value="expirado">Expirados</option>
                            </select>
                        </div>
                    </div>
                    <div style="display:flex;gap:12px">
                        <button class="btn btn-success" onclick="exportarValesExcel()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                            Exportar Excel
                        </button>
                        <button class="btn btn-danger" onclick="exportarValesPDF()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                            Exportar PDF
                        </button>
                    </div>
                </div>
            </div>

            <!-- Usu√°rios RH -->
            <div id="s-usuarios" class="section">
                <h1 class="page-title">Usu√°rios do RH</h1>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Gerenciar Usu√°rios</h3>
                        <button class="btn btn-primary" onclick="openModalUsuario()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Novo Usu√°rio</button>
                    </div>
                    <div id="tableUsuarios"></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Solicita√ß√µes de Recupera√ß√£o de Senha</h3>
                    </div>
                    <div id="tableSolicSenha"></div>
                </div>
            </div>

            <!-- Notifica√ß√µes -->
            <div id="s-notificacoes" class="section">
                <h1 class="page-title">Notifica√ß√µes e Webhooks</h1>
                
                <!-- A√ß√µes R√°pidas -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üîî Enviar Lembretes de Expira√ß√£o</h3>
                    </div>
                    <div style="padding:20px">
                        <p style="margin-bottom:16px;color:var(--text-secondary)">Enviar lembretes para colaboradores cujos vales est√£o pr√≥ximos de expirar:</p>
                        <div style="display:flex;gap:12px;flex-wrap:wrap">
                            <button class="btn btn-warning" onclick="enviarLembretes([7])">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/></svg>
                                Expiram em 7 dias
                            </button>
                            <button class="btn btn-warning" onclick="enviarLembretes([3])">
                                Expiram em 3 dias
                            </button>
                            <button class="btn btn-danger" onclick="enviarLembretes([1])">
                                Expiram amanh√£
                            </button>
                            <button class="btn btn-primary" onclick="enviarLembretes([7,3,1])">
                                Todos os lembretes
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Estat√≠sticas de Webhooks -->
                <div class="card" style="margin-top:20px">
                    <div class="card-header">
                        <h3 class="card-title">üìä Estat√≠sticas de Notifica√ß√µes (30 dias)</h3>
                    </div>
                    <div id="statsWebhooks" style="padding:20px"></div>
                </div>

                <!-- Logs de Webhooks -->
                <div class="card" style="margin-top:20px">
                    <div class="card-header">
                        <h3 class="card-title">üìú Hist√≥rico de Envios</h3>
                    </div>
                    <div class="search-bar" style="margin-bottom:0">
                        <select id="webhookTipo" class="form-control" style="width:auto">
                            <option value="">Todos os tipos</option>
                            <option value="codigo_gerado">C√≥digo Gerado</option>
                            <option value="lembrete_expiracao">Lembrete Expira√ß√£o</option>
                            <option value="vale_retirado">Vale Retirado</option>
                            <option value="senha_gerada">Senha Gerada</option>
                            <option value="senha_resetada">Senha Resetada</option>
                        </select>
                        <select id="webhookSucesso" class="form-control" style="width:auto">
                            <option value="">Todos os status</option>
                            <option value="true">Sucesso</option>
                            <option value="false">Falha</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadWebhookLogs()">Filtrar</button>
                    </div>
                    <div id="tableWebhookLogs" style="margin-top:20px"></div>
                </div>
            </div>

            <!-- Configura√ß√µes -->
            <div id="s-configuracoes" class="section">
                <h1 class="page-title">Configura√ß√µes do Sistema</h1>
                
                <!-- Configura√ß√µes de Vales -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üé´ Configura√ß√µes de Vales</h3>
                    </div>
                    <div style="padding:20px">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Vales por Colaborador/M√™s</label>
                                <input type="number" id="cfg_vales_por_mes" class="form-control" min="1" max="10" style="width:120px">
                                <small style="color:var(--text-secondary);display:block;margin-top:4px">Quantos vales cada colaborador pode receber por m√™s</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Dias de Validade do Vale</label>
                                <input type="number" id="cfg_dias_validade_vale" class="form-control" min="1" max="90" style="width:120px">
                                <small style="color:var(--text-secondary);display:block;margin-top:4px">Dias at√© o vale expirar ap√≥s gera√ß√£o</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configura√ß√µes de Automa√ß√£o -->
                <div class="card" style="margin-top:20px">
                    <div class="card-header">
                        <h3 class="card-title">‚è∞ Automa√ß√£o</h3>
                    </div>
                    <div style="padding:20px">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Dia da Gera√ß√£o Autom√°tica</label>
                                <input type="number" id="cfg_dia_geracao_automatica" class="form-control" min="1" max="28" style="width:120px">
                                <small style="color:var(--text-secondary);display:block;margin-top:4px">Dia do m√™s para gerar vales automaticamente (1-28)</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Dias para Lembrete de Expira√ß√£o</label>
                                <input type="text" id="cfg_notificar_expiracao_dias" class="form-control" style="width:180px" placeholder="7,3,1">
                                <small style="color:var(--text-secondary);display:block;margin-top:4px">Enviar lembrete X dias antes de expirar (separado por v√≠rgula)</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bot√£o Salvar -->
                <div style="margin-top:20px">
                    <button class="btn btn-primary btn-lg" onclick="salvarConfiguracoes()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                        Salvar Configura√ß√µes
                    </button>
                </div>

                <!-- Info -->
                <div class="card" style="margin-top:20px;background:#f0f9ff;border:1px solid #bae6fd">
                    <div style="padding:16px">
                        <p style="font-size:14px;color:#0369a1;margin-bottom:8px"><strong>‚ÑπÔ∏è Sobre as configura√ß√µes:</strong></p>
                        <ul style="font-size:13px;color:#0369a1;margin:0;padding-left:20px">
                            <li><strong>Vales por m√™s:</strong> Permite que colaboradores recebam m√∫ltiplos botij√µes por m√™s (ex: 2 para fam√≠lias maiores)</li>
                            <li><strong>Dias de validade:</strong> Ap√≥s esse per√≠odo, vales n√£o utilizados s√£o marcados como expirados</li>
                            <li><strong>Gera√ß√£o autom√°tica:</strong> Configure um cron job para chamar a API de gera√ß√£o no dia especificado</li>
                            <li><strong>Lembretes:</strong> Colaboradores receber√£o notifica√ß√µes nos dias configurados antes do vale expirar</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Auditoria -->
            <div id="s-auditoria" class="section">
                <!-- Header da Se√ß√£o -->
                <div style="margin-bottom:24px;display:flex;align-items:center;gap:12px">
                    <div style="width:48px;height:48px;background:linear-gradient(135deg,#7c3aed 0%,#a855f7 100%);border-radius:12px;display:flex;align-items:center;justify-content:center">
                        <svg width="24" height="24" fill="white" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
                    </div>
                    <div>
                        <h1 class="page-title" style="margin:0;font-size:24px">Logs de Auditoria</h1>
                        <p style="margin:4px 0 0;color:var(--text-secondary);font-size:14px">Rastreie todas as atividades realizadas no sistema</p>
                    </div>
                </div>

                <!-- Estat√≠sticas R√°pidas -->
                <div id="auditStats" class="stats-grid" style="margin-bottom:20px">
                    <div class="stat-card" style="border-left:4px solid #7c3aed">
                        <span class="stat-label">A√ß√µes Hoje</span>
                        <span class="stat-value" id="auditHoje">-</span>
                    </div>
                    <div class="stat-card" style="border-left:4px solid #3b82f6">
                        <span class="stat-label">Logins (7 dias)</span>
                        <span class="stat-value" id="auditLogins">-</span>
                    </div>
                    <div class="stat-card" style="border-left:4px solid var(--success)">
                        <span class="stat-label">Reembolsos Processados</span>
                        <span class="stat-value" id="auditReembolsos">-</span>
                    </div>
                    <div class="stat-card" style="border-left:4px solid var(--warning)">
                        <span class="stat-label">Vales Gerados (m√™s)</span>
                        <span class="stat-value" id="auditVales">-</span>
                    </div>
                </div>

                <div class="card" style="border-top:3px solid #7c3aed">
                    <div class="card-header">
                        <h3 class="card-title" style="display:flex;align-items:center;gap:8px">
                            <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>
                            Filtros de Pesquisa
                        </h3>
                    </div>
                    <div class="search-bar" style="flex-wrap:wrap;gap:12px;padding:16px">
                        <div style="display:flex;flex-direction:column;gap:4px">
                            <label style="font-size:11px;font-weight:600;color:var(--text-secondary)">Data Inicial</label>
                            <input type="date" id="auditDataIni" class="form-control" style="width:150px">
                        </div>
                        <div style="display:flex;flex-direction:column;gap:4px">
                            <label style="font-size:11px;font-weight:600;color:var(--text-secondary)">Data Final</label>
                            <input type="date" id="auditDataFim" class="form-control" style="width:150px">
                        </div>
                        <div style="display:flex;flex-direction:column;gap:4px">
                            <label style="font-size:11px;font-weight:600;color:var(--text-secondary)">Tipo de Usu√°rio</label>
                            <select id="auditTipoUsuario" class="form-control" style="width:150px">
                                <option value="">Todos</option>
                                <option value="admin">RH/Admin</option>
                                <option value="colaborador">Colaborador</option>
                                <option value="distribuidor">Distribuidor</option>
                            </select>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:4px">
                            <label style="font-size:11px;font-weight:600;color:var(--text-secondary)">Categoria</label>
                            <select id="auditAcao" class="form-control" style="width:200px">
                                <option value="">Todas as a√ß√µes</option>
                                <optgroup label="Autentica√ß√£o">
                                    <option value="login">Login</option>
                                    <option value="logout">Logout</option>
                                    <option value="login_falha">Falha de Login</option>
                                </optgroup>
                                <optgroup label="Colaboradores">
                                    <option value="criar_colaborador">Criar Colaborador</option>
                                    <option value="editar_colaborador">Editar Colaborador</option>
                                    <option value="ativar_colaborador">Ativar Colaborador</option>
                                    <option value="desativar_colaborador">Desativar Colaborador</option>
                                    <option value="resetar_senha_colaborador">Resetar Senha</option>
                                </optgroup>
                                <optgroup label="Distribuidores">
                                    <option value="criar_distribuidor">Criar Distribuidor</option>
                                    <option value="editar_distribuidor">Editar Distribuidor</option>
                                    <option value="ativar_distribuidor">Ativar Distribuidor</option>
                                    <option value="desativar_distribuidor">Desativar Distribuidor</option>
                                    <option value="resetar_senha_distribuidor">Resetar Senha</option>
                                </optgroup>
                                <optgroup label="Vales">
                                    <option value="gerar_vale">Gerar Vale Individual</option>
                                    <option value="gerar_vales_mensal">Gerar Vales Mensal</option>
                                    <option value="validar_vale">Validar Vale</option>
                                    <option value="confirmar_retirada">Confirmar Retirada</option>
                                </optgroup>
                                <optgroup label="Reembolsos">
                                    <option value="criar_reembolso">Criar Reembolso</option>
                                    <option value="aprovar_reembolso">Aprovar Reembolso</option>
                                    <option value="rejeitar_reembolso">Rejeitar Reembolso</option>
                                    <option value="pagar_reembolso">Pagar Reembolso</option>
                                    <option value="editar_reembolso">Editar Reembolso</option>
                                    <option value="excluir_reembolso">Excluir Reembolso</option>
                                    <option value="upload_documento">Upload Documento</option>
                                </optgroup>
                                <optgroup label="Usu√°rios RH">
                                    <option value="criar_usuario">Criar Usu√°rio</option>
                                    <option value="editar_usuario">Editar Usu√°rio</option>
                                    <option value="ativar_usuario">Ativar Usu√°rio</option>
                                    <option value="desativar_usuario">Desativar Usu√°rio</option>
                                </optgroup>
                                <optgroup label="Sistema">
                                    <option value="alterar_configuracao">Alterar Configura√ß√£o</option>
                                    <option value="aprovar_solicitacao">Aprovar Solicita√ß√£o</option>
                                    <option value="rejeitar_solicitacao">Rejeitar Solicita√ß√£o</option>
                                </optgroup>
                            </select>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:4px">
                            <label style="font-size:11px;font-weight:600;color:var(--text-secondary)">Buscar Nome</label>
                            <input type="text" id="auditBusca" class="form-control" placeholder="Nome do usu√°rio..." style="width:180px">
                        </div>
                        <div style="display:flex;align-items:flex-end">
                            <button class="btn btn-primary" onclick="loadAuditoria()" style="height:38px">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="margin-right:6px"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                Filtrar
                            </button>
                        </div>
                        <div style="display:flex;align-items:flex-end">
                            <button class="btn btn-outline" onclick="limparFiltrosAuditoria()" style="height:38px">Limpar</button>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top:16px">
                    <div class="card-header">
                        <h3 class="card-title">Hist√≥rico Completo de Atividades</h3>
                        <span id="auditTotal" style="font-size:13px;color:var(--text-secondary)"></span>
                    </div>
                    <div id="tableAuditoria" style="margin-top:0"></div>
                    <div id="paginacaoAuditoria" style="padding:16px;display:flex;gap:8px;justify-content:center;border-top:1px solid var(--border)"></div>
                </div>
            </div>

        </main>
    </div>

    <!-- Modal Colaborador -->
    <div id="modalColab" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalColabT">Novo Colaborador</h3>
                <button class="modal-close" onclick="closeModal('colab')">&times;</button>
            </div>
            <form id="formColab">
                <div class="modal-body">
                    <input type="hidden" id="cId">
                    <div id="senhaGerada" class="senha-box" style="display:none; margin-bottom: 16px;">
                        <small>Senha gerada:</small>
                        <code id="senhaValor"></code>
                        <small>Anote esta senha! Ela ser√° enviada ao colaborador.</small>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Nome completo *</label><input type="text" id="cNome" class="form-control" required></div>
                        <div class="form-group"><label class="form-label">CPF *</label><input type="text" id="cCpf" class="form-control" required placeholder="000.000.000-00"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Email *</label><input type="email" id="cEmail" class="form-control" required></div>
                        <div class="form-group"><label class="form-label">Telefone *</label><input type="text" id="cTel" class="form-control" required placeholder="(00) 00000-0000"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Matr√≠cula</label><input type="text" id="cMat" class="form-control"></div>
                        <div class="form-group"><label class="form-label">Data Admiss√£o *</label><input type="date" id="cAdm" class="form-control" required></div>
                    </div>
                    <div class="form-group"><label class="form-label">Setor</label><input type="text" id="cSetor" class="form-control"></div>
                    
                    <h4 style="margin: 20px 0 12px; font-size: 14px; color: var(--text-secondary);">Endere√ßo</h4>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">CEP *</label><input type="text" id="cCep" class="form-control" required onblur="fetchCep('c')"></div>
                        <div class="form-group"><label class="form-label">Logradouro *</label><input type="text" id="cLog" class="form-control" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">N√∫mero *</label><input type="text" id="cNum" class="form-control" required></div>
                        <div class="form-group"><label class="form-label">Complemento</label><input type="text" id="cComp" class="form-control"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Bairro *</label><input type="text" id="cBairro" class="form-control" required></div>
                        <div class="form-group"><label class="form-label">Cidade *</label><input type="text" id="cCidade" class="form-control" required></div>
                    </div>
                    <div class="form-group" style="max-width: 100px;"><label class="form-label">UF *</label><input type="text" id="cUF" class="form-control" required maxlength="2" style="text-transform: uppercase;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal('colab')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Distribuidor -->
    <div id="modalDist" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalDistT">Novo Distribuidor</h3>
                <button class="modal-close" onclick="closeModal('dist')">&times;</button>
            </div>
            <form id="formDist">
                <div class="modal-body">
                    <input type="hidden" id="dId">
                    <div id="senhaDist" class="senha-box" style="display:none; margin-bottom: 16px;">
                        <small>Senha gerada:</small>
                        <code id="senhaDistValor"></code>
                        <small>Anote esta senha!</small>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Nome *</label><input type="text" id="dNome" class="form-control" required></div>
                        <div class="form-group"><label class="form-label">CNPJ *</label><input type="text" id="dCnpj" class="form-control" required placeholder="00.000.000/0000-00"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Email *</label><input type="email" id="dEmail" class="form-control" required></div>
                        <div class="form-group"><label class="form-label">Telefone *</label><input type="text" id="dTel" class="form-control" required></div>
                    </div>
                    <div class="form-group"><label class="form-label">Respons√°vel *</label><input type="text" id="dResp" class="form-control" required></div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Hor√°rio de Funcionamento</label><input type="text" id="dHor" class="form-control" placeholder="Ex: Seg-Sex 8h √†s 18h"></div>
                        <div class="form-group">
                            <label class="form-label">Tipo de Distribuidor *</label>
                            <select id="dTipo" class="form-control" required onchange="toggleDadosBancarios()">
                                <option value="externo">Externo (Recebe Reembolso)</option>
                                <option value="interno">Interno (Consigaz)</option>
                            </select>
                            <small style="color: var(--text-secondary);">Apenas distribuidores externos recebem reembolsos</small>
                        </div>
                    </div>

                    <h4 style="margin: 20px 0 12px; font-size: 14px; color: var(--text-secondary);">Endere√ßo</h4>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">CEP *</label><input type="text" id="dCep" class="form-control" required onblur="fetchCep('d')"></div>
                        <div class="form-group"><label class="form-label">Logradouro *</label><input type="text" id="dLog" class="form-control" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">N√∫mero *</label><input type="text" id="dNum" class="form-control" required></div>
                        <div class="form-group"><label class="form-label">Complemento</label><input type="text" id="dComp" class="form-control"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Bairro *</label><input type="text" id="dBairro" class="form-control" required></div>
                        <div class="form-group"><label class="form-label">Cidade *</label><input type="text" id="dCidade" class="form-control" required></div>
                    </div>
                    <div class="form-group" style="max-width: 100px;"><label class="form-label">UF *</label><input type="text" id="dUF" class="form-control" required maxlength="2"></div>

                    <div id="dadosBancarios" style="display:none">
                        <h4 style="margin: 20px 0 12px; font-size: 14px; color: var(--text-secondary);">Dados Banc√°rios (para Reembolso)</h4>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Banco</label><input type="text" id="dBanco" class="form-control" placeholder="Ex: Banco do Brasil"></div>
                            <div class="form-group"><label class="form-label">Ag√™ncia</label><input type="text" id="dAgencia" class="form-control" placeholder="Ex: 1234-5"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Conta</label><input type="text" id="dConta" class="form-control" placeholder="Ex: 12345-6"></div>
                            <div class="form-group">
                                <label class="form-label">Tipo de Conta</label>
                                <select id="dTipoConta" class="form-control">
                                    <option value="">Selecione...</option>
                                    <option value="corrente">Corrente</option>
                                    <option value="poupanca">Poupan√ßa</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group"><label class="form-label">Chave PIX</label><input type="text" id="dPix" class="form-control" placeholder="CPF, CNPJ, Email, Telefone ou Chave Aleat√≥ria"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal('dist')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Gerar Vales -->
    <div id="modalVales" class="modal">
        <div class="modal-content" style="max-width:700px">
            <div class="modal-header">
                <h3 class="modal-title">Gerar Vales do M√™s</h3>
                <button class="modal-close" onclick="closeModal('vales')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom:20px">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-bottom:12px">
                        <input type="radio" name="tipoGeracao" value="todos" checked onchange="toggleSelecaoColabs()">
                        <span><strong>Gerar para TODOS os colaboradores ativos</strong></span>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                        <input type="radio" name="tipoGeracao" value="selecionados" onchange="toggleSelecaoColabs()">
                        <span><strong>Selecionar colaboradores espec√≠ficos</strong></span>
                    </label>
                </div>
                <div id="selecaoColabs" style="display:none;border:1px solid var(--gray-200);border-radius:8px;padding:16px;max-height:350px;overflow-y:auto">
                    <div style="margin-bottom:12px;display:flex;gap:8px;align-items:center">
                        <input type="text" id="buscaColabVale" class="form-control" placeholder="Buscar colaborador..." style="flex:1" onkeyup="filtrarColabsVale()">
                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px;white-space:nowrap">
                            <input type="checkbox" id="selecionarTodosColabs" onchange="toggleTodosColabs()">
                            Selecionar todos
                        </label>
                    </div>
                    <div id="listaColabsVale"></div>
                </div>
                <div id="resumoSelecao" style="margin-top:16px;padding:12px;background:var(--gray-50);border-radius:8px;font-size:14px">
                    <span id="qtdSelecionados">Todos os colaboradores ativos ser√£o contemplados</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('vales')">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="executarGeracaoVales()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                    Gerar Vales
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Usu√°rio RH -->
    <div id="modalUsuario" class="modal">
        <div class="modal-content" style="max-width:500px">
            <div class="modal-header">
                <h3 class="modal-title" id="modalUsuarioT">Novo Usu√°rio RH</h3>
                <button class="modal-close" onclick="closeModal('usuario')">&times;</button>
            </div>
            <form id="formUsuario" onsubmit="salvarUsuario(event)">
                <div class="modal-body">
                    <input type="hidden" id="uId">
                    <div class="form-group">
                        <label class="form-label">Nome Completo *</label>
                        <input type="text" id="uNome" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email *</label>
                        <input type="email" id="uEmail" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">N√≠vel de Acesso *</label>
                        <select id="uNivel" class="form-control" required>
                            <option value="operador">Operador - Visualiza e gera vales</option>
                            <option value="supervisor">Supervisor - Gerencia colaboradores e distribuidores</option>
                            <option value="admin">Administrador - Acesso total</option>
                        </select>
                    </div>
                    <div id="formUsuarioSenha" class="form-group">
                        <label class="form-label">Senha *</label>
                        <input type="password" id="uSenha" class="form-control" minlength="6">
                        <small style="color:var(--text-secondary)">M√≠nimo 6 caracteres. Deixe em branco para manter a atual (ao editar).</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal('usuario')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Exibir Senha (melhorado) -->
    <div id="modalSenha" class="modal">
        <div class="modal-content" style="max-width:450px">
            <div class="modal-header" style="background:var(--success);color:white">
                <h3 class="modal-title">‚úì Senha Gerada com Sucesso</h3>
                <button class="modal-close" onclick="closeModal('senha')" style="color:white">&times;</button>
            </div>
            <div class="modal-body" style="text-align:center;padding:32px">
                <p style="margin-bottom:8px;color:var(--text-secondary)">A nova senha para</p>
                <p style="font-weight:600;font-size:18px;margin-bottom:24px" id="senhaUsuarioNome"></p>
                <div style="background:var(--gray-100);border:2px dashed var(--gray-300);border-radius:12px;padding:24px;margin-bottom:24px">
                    <p style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">NOVA SENHA</p>
                    <p style="font-size:28px;font-weight:700;font-family:monospace;letter-spacing:2px;color:var(--primary)" id="senhaGeradaValor"></p>
                </div>
                <div style="background:#fef3cd;border:1px solid #ffc107;border-radius:8px;padding:12px;text-align:left">
                    <p style="font-size:13px;color:#856404"><strong>‚ö†Ô∏è Importante:</strong> Anote esta senha e envie ao usu√°rio de forma segura. Ela n√£o poder√° ser visualizada novamente.</p>
                </div>
            </div>
            <div class="modal-footer" style="justify-content:center">
                <button type="button" class="btn btn-primary" onclick="copiarSenha()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                    Copiar Senha
                </button>
                <button type="button" class="btn btn-outline" onclick="closeModal('senha')">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Importa√ß√£o -->
    <div id="modalImportacao" class="modal">
        <div class="modal-content" style="max-width:700px">
            <div class="modal-header">
                <h3 class="modal-title">üì§ Importar Colaboradores</h3>
                <button class="modal-close" onclick="closeModal('importacao')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Etapa 1: Upload -->
                <div id="importEtapa1">
                    <div style="background:var(--gray-50);border:2px dashed var(--gray-300);border-radius:12px;padding:32px;text-align:center;margin-bottom:24px">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color:var(--text-secondary)" stroke-width="2" style="margin-bottom:16px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        <p style="margin-bottom:16px;color:var(--text-secondary)">Selecione um arquivo Excel (.xlsx) ou CSV</p>
                        <input type="file" id="arquivoImportacao" accept=".xlsx,.xls,.csv" style="display:none" onchange="processarArquivoImportacao(this)">
                        <button class="btn btn-primary" onclick="document.getElementById('arquivoImportacao').click()">Selecionar Arquivo</button>
                    </div>
                    
                    <div style="background:#e0f2fe;border:1px solid #0ea5e9;border-radius:8px;padding:16px;margin-bottom:16px">
                        <p style="font-size:14px;font-weight:600;color:#0369a1;margin-bottom:8px">üìã Formato esperado do arquivo:</p>
                        <p style="font-size:13px;color:#0369a1;margin-bottom:12px">O arquivo deve conter as seguintes colunas (na primeira linha):</p>
                        <div style="display:flex;flex-wrap:wrap;gap:6px">
                            <span style="background:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500">nome*</span>
                            <span style="background:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500">cpf*</span>
                            <span style="background:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500">email*</span>
                            <span style="background:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500">telefone*</span>
                            <span style="background:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500">cidade*</span>
                            <span style="background:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500">estado*</span>
                            <span style="background:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500">data_admissao*</span>
                            <span style="background:white;padding:4px 8px;border-radius:4px;font-size:12px;color:var(--text-secondary)">matricula</span>
                            <span style="background:white;padding:4px 8px;border-radius:4px;font-size:12px;color:var(--text-secondary)">setor</span>
                        </div>
                        <p style="font-size:11px;color:#0369a1;margin-top:8px">* Campos obrigat√≥rios</p>
                    </div>
                    
                    <button class="btn btn-outline" onclick="baixarModeloImportacao()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Baixar Modelo Excel
                    </button>
                </div>
                
                <!-- Etapa 2: Preview e Valida√ß√£o -->
                <div id="importEtapa2" style="display:none">
                    <div id="importResumo" style="margin-bottom:20px"></div>
                    <div style="max-height:300px;overflow-y:auto;border:1px solid var(--gray-200);border-radius:8px">
                        <table id="importPreview"></table>
                    </div>
                </div>
                
                <!-- Etapa 3: Resultado -->
                <div id="importEtapa3" style="display:none">
                    <div id="importResultado"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('importacao')">Cancelar</button>
                <button type="button" id="btnConfirmarImport" class="btn btn-primary" style="display:none" onclick="confirmarImportacao()">Importar Colaboradores</button>
            </div>
        </div>
    </div>

    <!-- Modal Importa√ß√£o Distribuidores -->
    <div id="modalImportDist" class="modal">
        <div class="modal-content" style="max-width:750px">
            <div class="modal-header">
                <h3 class="modal-title">üì§ Importar Distribuidores</h3>
                <button class="modal-close" onclick="closeModal('importDist')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Etapa 1: Upload -->
                <div id="importDistEtapa1">
                    <div style="background:var(--gray-50);border:2px dashed var(--gray-300);border-radius:12px;padding:32px;text-align:center;margin-bottom:24px">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color:var(--text-secondary)" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        <p style="margin-bottom:16px;color:var(--text-secondary)">Selecione um arquivo Excel (.xlsx) ou CSV</p>
                        <input type="file" id="arquivoImportDist" accept=".xlsx,.xls,.csv" style="display:none" onchange="processarArquivoImportDist(this)">
                        <button class="btn btn-primary" onclick="document.getElementById('arquivoImportDist').click()">Selecionar Arquivo</button>
                    </div>

                    <div style="background:#e0f2fe;border:1px solid #0ea5e9;border-radius:8px;padding:16px;margin-bottom:16px">
                        <p style="font-size:14px;font-weight:600;color:#0369a1;margin-bottom:8px">üìã Formato esperado do arquivo:</p>
                        <p style="font-size:13px;color:#0369a1;margin-bottom:12px">O arquivo deve conter as seguintes colunas (na primeira linha):</p>
                        <div style="display:flex;flex-wrap:wrap;gap:6px">
                            <span style="background:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500">nome*</span>
                            <span style="background:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500">cnpj*</span>
                            <span style="background:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500">email*</span>
                            <span style="background:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500">telefone*</span>
                            <span style="background:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500">responsavel*</span>
                            <span style="background:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500">cep*</span>
                            <span style="background:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500">logradouro*</span>
                            <span style="background:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500">numero*</span>
                            <span style="background:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500">bairro*</span>
                            <span style="background:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500">cidade*</span>
                            <span style="background:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500">estado*</span>
                            <span style="background:white;padding:4px 8px;border-radius:4px;font-size:12px;color:var(--text-secondary)">complemento</span>
                            <span style="background:white;padding:4px 8px;border-radius:4px;font-size:12px;color:var(--text-secondary)">horario_funcionamento</span>
                            <span style="background:white;padding:4px 8px;border-radius:4px;font-size:12px;color:var(--text-secondary)">tipo_distribuidor</span>
                        </div>
                        <p style="font-size:11px;color:#0369a1;margin-top:8px">* Campos obrigat√≥rios | tipo_distribuidor: "interno" ou "externo" (padr√£o: externo)</p>
                    </div>

                    <button class="btn btn-outline" onclick="baixarModeloImportDist()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Baixar Modelo Excel
                    </button>
                </div>

                <!-- Etapa 2: Preview e Valida√ß√£o -->
                <div id="importDistEtapa2" style="display:none">
                    <div id="importDistResumo" style="margin-bottom:20px"></div>
                    <div style="max-height:300px;overflow-y:auto;border:1px solid var(--gray-200);border-radius:8px">
                        <table id="importDistPreview"></table>
                    </div>
                </div>

                <!-- Etapa 3: Resultado -->
                <div id="importDistEtapa3" style="display:none">
                    <div id="importDistResultado"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('importDist')">Cancelar</button>
                <button type="button" id="btnConfirmarImportDist" class="btn btn-primary" style="display:none" onclick="confirmarImportDist()">Importar Distribuidores</button>
            </div>
        </div>
    </div>

    <!-- Modal Detalhes Reembolso -->
    <div id="modalReembolso" class="modal">
        <div class="modal-content" style="max-width:800px">
            <div class="modal-header">
                <h3 class="modal-title">Detalhes do Reembolso #<span id="det-reembolso-id"></span></h3>
                <button class="modal-close" onclick="closeModal('reembolso')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:20px">
                    <div><strong>Distribuidor:</strong><br><span id="det-distribuidor"></span></div>
                    <div><strong>CNPJ:</strong><br><span id="det-cnpj"></span></div>
                    <div><strong>Colaborador:</strong><br><span id="det-colaborador"></span></div>
                    <div><strong>CPF:</strong><br><span id="det-cpf"></span></div>
                    <div><strong>C√≥digo Vale:</strong><br><span id="det-codigo-vale"></span></div>
                    <div><strong>M√™s Refer√™ncia:</strong><br><span id="det-mes-ref"></span></div>
                    <div><strong>Valor:</strong><br><span id="det-valor" style="font-size:18px;font-weight:600;color:var(--success)"></span></div>
                    <div><strong>Status:</strong><br><span id="det-status"></span></div>
                </div>
                <div style="margin-bottom:20px">
                    <strong>Dados Banc√°rios:</strong>
                    <div style="background:var(--gray-50);padding:12px;border-radius:8px;margin-top:8px">
                        <span id="det-banco"></span> | Ag: <span id="det-agencia"></span> | Conta: <span id="det-conta"></span> (<span id="det-tipo-conta"></span>)<br>
                        PIX: <span id="det-pix"></span>
                    </div>
                </div>
                <div id="det-observacoes-container" style="display:none;margin-bottom:20px">
                    <strong>Observa√ß√µes:</strong>
                    <p id="det-observacoes" style="background:var(--gray-50);padding:12px;border-radius:8px;margin-top:8px"></p>
                </div>

                <!-- Se√ß√£o de Documentos/NF -->
                <div style="margin-bottom:20px">
                    <strong>Documentos:</strong>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:8px">
                        <!-- Nota Fiscal -->
                        <div style="background:var(--gray-50);padding:12px;border-radius:8px;border:1px dashed var(--border-color)">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                                <span style="font-weight:500;font-size:13px">Nota Fiscal</span>
                                <span id="det-nf-status" class="badge badge-warning">Pendente</span>
                            </div>
                            <div id="det-nf-preview" style="display:none;margin-bottom:8px">
                                <a id="det-nf-link" href="#" target="_blank" class="btn btn-sm btn-outline" style="width:100%">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                                    Ver Arquivo
                                </a>
                            </div>
                            <div id="det-nf-upload">
                                <input type="file" id="uploadNF" accept=".pdf,.jpg,.jpeg,.png,.xml" style="display:none" onchange="uploadArquivoReembolso('nf')">
                                <button type="button" class="btn btn-sm btn-primary" style="width:100%" onclick="document.getElementById('uploadNF').click()">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                    Anexar NF
                                </button>
                            </div>
                        </div>
                        <!-- Recibo -->
                        <div style="background:var(--gray-50);padding:12px;border-radius:8px;border:1px dashed var(--border-color)">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                                <span style="font-weight:500;font-size:13px">Recibo</span>
                                <span id="det-recibo-status" class="badge badge-warning">Pendente</span>
                            </div>
                            <div id="det-recibo-preview" style="display:none;margin-bottom:8px">
                                <a id="det-recibo-link" href="#" target="_blank" class="btn btn-sm btn-outline" style="width:100%">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                                    Ver Arquivo
                                </a>
                            </div>
                            <div id="det-recibo-upload">
                                <input type="file" id="uploadRecibo" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="uploadArquivoReembolso('recibo')">
                                <button type="button" class="btn btn-sm btn-outline" style="width:100%" onclick="document.getElementById('uploadRecibo').click()">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                    Anexar Recibo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="acoesReembolso">
                <button type="button" class="btn btn-outline" onclick="closeModal('reembolso')">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Aprovar Reembolso -->
    <div id="modalAprovarReembolso" class="modal">
        <div class="modal-content" style="max-width:500px">
            <div class="modal-header" style="background:var(--success);color:white">
                <h3 class="modal-title">Aprovar Reembolso</h3>
                <button class="modal-close" onclick="closeModal('aprovarReembolso')" style="color:white">&times;</button>
            </div>
            <form onsubmit="confirmarAprovacao(event)">
                <div class="modal-body">
                    <p style="margin-bottom:16px">Voc√™ est√° prestes a aprovar este reembolso. Ap√≥s a aprova√ß√£o, ele ficar√° pendente de pagamento.</p>
                    <div class="form-group">
                        <label>Observa√ß√µes (opcional)</label>
                        <textarea id="aprovar-observacoes" class="form-control" rows="3" placeholder="Adicione observa√ß√µes..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal('aprovarReembolso')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Aprovar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Rejeitar Reembolso -->
    <div id="modalRejeitarReembolso" class="modal">
        <div class="modal-content" style="max-width:500px">
            <div class="modal-header" style="background:var(--danger);color:white">
                <h3 class="modal-title">Rejeitar Reembolso</h3>
                <button class="modal-close" onclick="closeModal('rejeitarReembolso')" style="color:white">&times;</button>
            </div>
            <form onsubmit="confirmarRejeicao(event)">
                <div class="modal-body">
                    <p style="margin-bottom:16px;color:var(--danger)">Esta a√ß√£o registrar√° o motivo da rejei√ß√£o.</p>
                    <div class="form-group">
                        <label>Motivo da Rejei√ß√£o *</label>
                        <textarea id="rejeitar-motivo" class="form-control" rows="4" placeholder="Descreva o motivo..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal('rejeitarReembolso')">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Rejeitar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Marcar Pago -->
    <div id="modalMarcarPago" class="modal">
        <div class="modal-content" style="max-width:500px">
            <div class="modal-header" style="background:var(--success);color:white">
                <h3 class="modal-title">Marcar como Pago</h3>
                <button class="modal-close" onclick="closeModal('marcarPago')" style="color:white">&times;</button>
            </div>
            <form onsubmit="confirmarPagamento(event)">
                <div class="modal-body">
                    <p style="margin-bottom:16px">Confirme que o pagamento foi realizado.</p>
                    <div class="form-group">
                        <label>Observa√ß√µes (opcional)</label>
                        <textarea id="pago-observacoes" class="form-control" rows="3" placeholder="Ex: Pago via PIX..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeModal('marcarPago')">Cancelar</button>
                    <button type="submit" class="btn btn-success">Confirmar Pagamento</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Novo Reembolso -->
    <div id="modalNovoReembolso" class="modal">
        <div class="modal-content" style="max-width:800px">
            <div class="modal-header">
                <h3 class="modal-title">Criar Reembolso</h3>
                <button class="modal-close" onclick="closeModal('novoReembolso')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:16px;color:var(--text-secondary)">Selecione um distribuidor externo para ver os vales pendentes de reembolso.</p>
                <div class="form-group">
                    <label>Distribuidor Externo *</label>
                    <select id="novo-reembolso-distribuidor" class="form-control" onchange="carregarValesPendentes()">
                        <option value="">Selecione um distribuidor...</option>
                    </select>
                </div>
                <div id="vales-pendentes-container" style="display:none;margin-top:20px">
                    <h4 style="margin-bottom:12px">Vales Pendentes de Reembolso</h4>
                    <div id="tabela-vales-pendentes"></div>
                    <div id="resumo-selecao" style="display:none;margin-top:16px;padding:12px;background:var(--gray-50);border-radius:8px">
                        <span><strong id="qtd-vales-selecionados">0</strong> vale(s) selecionado(s)</span>
                        <span style="float:right;font-weight:600;color:var(--success)">Total: R$ <span id="total-reembolso">0,00</span></span>
                    </div>
                    <div class="form-group" style="margin-top:16px">
                        <label>Observa√ß√µes (opcional)</label>
                        <textarea id="novo-observacoes" class="form-control" rows="2" placeholder="Observa√ß√µes..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('novoReembolso')">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-criar-reembolsos" onclick="criarReembolsosSelecionados()" disabled>Criar Reembolso(s)</button>
            </div>
        </div>
    </div>

<script>
const API='/api';
let token=localStorage.getItem('token'),user=JSON.parse(localStorage.getItem('usuario')||'{}');
// Expor token globalmente para scripts externos (reembolsos-script.js)
window.token = token;
if(!token||user.tipo!=='admin')location.href='login-admin.html';
document.getElementById('userName').textContent=user.nome+' ('+user.nivel+')';

// ==================== TEMA ====================
function initTheme(){
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);
}

function toggleTheme(){
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeIcon(newTheme);
}

function updateThemeIcon(theme){
    document.getElementById('iconSol').style.display = theme === 'dark' ? 'block' : 'none';
    document.getElementById('iconLua').style.display = theme === 'dark' ? 'none' : 'block';
}

// Sidebar Toggle
function toggleSidebar(){
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('collapsed');
    const isCollapsed = sidebar.classList.contains('collapsed');
    localStorage.setItem('sidebarCollapsed', isCollapsed);
}

function initSidebar(){
    const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    if(isCollapsed){
        document.getElementById('sidebar').classList.add('collapsed');
    }
}

initSidebar();
initTheme();

const hoje=new Date(),mesAtual=`${hoje.getFullYear()}-${String(hoje.getMonth()+1).padStart(2,'0')}`;
document.getElementById('filterMes').value=mesAtual;
document.getElementById('relIni').value=mesAtual;
document.getElementById('relFim').value=mesAtual;
document.getElementById('expValesMes').value=mesAtual;

async function api(ep,opt={}){
    try{
        const r=await fetch(API+ep,{...opt,headers:{'Content-Type':'application/json','Authorization':'Bearer '+token,...opt.headers}});
        if(r.status===401){logout();return null}
        return r.json();
    }catch(e){console.error(e);return null}
}
function logout(){localStorage.clear();location.href='login-admin.html'}

// Navigation
document.querySelectorAll('.sidebar-menu a').forEach(a=>a.onclick=e=>{
    e.preventDefault();
    document.querySelectorAll('.sidebar-menu a').forEach(x=>x.classList.remove('active'));
    a.classList.add('active');
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.getElementById('s-'+a.dataset.section).classList.add('active');
    if(a.dataset.section==='dashboard')loadDash();
    if(a.dataset.section==='colaboradores')loadColabs();
    if(a.dataset.section==='distribuidores')loadDists();
    if(a.dataset.section==='vales')loadVales();
    if(a.dataset.section==='reembolsos'){
        loadReembolsos();
        carregarDistribuidoresFiltro();
    }
    if(a.dataset.section==='solicitacoes')loadSolic();
    if(a.dataset.section==='usuarios'){loadUsuarios();loadSolicSenha();}
    if(a.dataset.section==='notificacoes'){loadWebhookStats();loadWebhookLogs();}
    if(a.dataset.section==='configuracoes')loadConfiguracoes();
    if(a.dataset.section==='auditoria')loadAuditoria();
});

// Mostrar menu de usu√°rios, notifica√ß√µes, configura√ß√µes e auditoria apenas para admin
if(user.nivel === 'admin'){
    document.getElementById('menuUsuarios').style.display = 'block';
    document.getElementById('menuNotificacoes').style.display = 'block';
    document.getElementById('menuConfiguracoes').style.display = 'block';
    document.getElementById('menuAuditoria').style.display = 'block';
}

// Dashboard
async function loadDash(){
    const d=await api('/admin/dashboard');
    if(!d||!d.dados)return;
    const s=d.dados;
    document.getElementById('statsGrid').innerHTML=`
        <div class="stat-card"><div class="stat-card-icon blue"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div><h3>${s.colaboradores.total}</h3><p>Colaboradores Ativos</p></div>
        <div class="stat-card"><div class="stat-card-icon green"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg></div><h3>${s.distribuidores.total}</h3><p>Distribuidores</p></div>
        <div class="stat-card"><div class="stat-card-icon orange"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg></div><h3>${s.vales_mes.utilizados}/${s.vales_mes.total}</h3><p>Vales Utilizados (${s.vales_mes.taxa_utilizacao}%)</p></div>
        <div class="stat-card"><div class="stat-card-icon red"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div><h3>${s.solicitacoes_pendentes}</h3><p>Solicita√ß√µes Pendentes</p></div>`;
    document.getElementById('chartDist').innerHTML=s.retiradas_por_distribuidor.length?
        `<table><thead><tr><th>Distribuidor</th><th>Retiradas</th></tr></thead><tbody>${s.retiradas_por_distribuidor.map(r=>`<tr><td>${r.nome}</td><td><span class="badge badge-info">${r.total_retiradas}</span></td></tr>`).join('')}</tbody></table>`:
        '<div class="empty-state"><p>Nenhuma retirada este m√™s</p></div>';
    
    // Carregar dados para gr√°ficos
    loadDashCharts();
}

// Vari√°veis para armazenar inst√¢ncias dos gr√°ficos
let chartRetiradas, chartStatus, chartTaxa, chartDistribuidores;
let chartReembolsosMes, chartReembolsosStatus, chartReembolsosValor, chartReembolsosDist;

async function loadDashCharts(){
    const d = await api('/admin/dashboard/graficos');
    if(!d || !d.dados) return;
    const g = d.dados;
    
    // Destruir gr√°ficos existentes
    if(chartRetiradas) chartRetiradas.destroy();
    if(chartStatus) chartStatus.destroy();
    if(chartTaxa) chartTaxa.destroy();
    if(chartDistribuidores) chartDistribuidores.destroy();
    
    // Gr√°fico 1: Retiradas por M√™s (Barras)
    const ctxRetiradas = document.getElementById('chartRetiradas').getContext('2d');
    chartRetiradas = new Chart(ctxRetiradas, {
        type: 'bar',
        data: {
            labels: g.retiradas_por_mes.map(m => m.mes_nome),
            datasets: [{
                label: 'Retiradas',
                data: g.retiradas_por_mes.map(m => m.total),
                backgroundColor: 'rgba(5, 52, 98, 0.8)',
                borderColor: '#053462',
                borderWidth: 1,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } }
            }
        }
    });
    
    // Gr√°fico 2: Status dos Vales (Pizza)
    const ctxStatus = document.getElementById('chartStatus').getContext('2d');
    chartStatus = new Chart(ctxStatus, {
        type: 'doughnut',
        data: {
            labels: ['Ativos', 'Utilizados', 'Expirados'],
            datasets: [{
                data: [g.status_vales.ativos, g.status_vales.utilizados, g.status_vales.expirados],
                backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { padding: 20 } }
            }
        }
    });
    
    // Gr√°fico 3: Taxa de Utiliza√ß√£o (Linha)
    const ctxTaxa = document.getElementById('chartTaxa').getContext('2d');
    chartTaxa = new Chart(ctxTaxa, {
        type: 'line',
        data: {
            labels: g.taxa_utilizacao.map(m => m.mes_nome),
            datasets: [{
                label: 'Taxa de Utiliza√ß√£o %',
                data: g.taxa_utilizacao.map(m => m.taxa),
                borderColor: '#DC3E31',
                backgroundColor: 'rgba(220, 62, 49, 0.1)',
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#DC3E31',
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } }
            }
        }
    });
    
    // Gr√°fico 4: Top Distribuidores (Barras Horizontais)
    const ctxDist = document.getElementById('chartDistribuidores').getContext('2d');
    chartDistribuidores = new Chart(ctxDist, {
        type: 'bar',
        data: {
            labels: g.top_distribuidores.map(d => d.nome.length > 20 ? d.nome.substring(0,20)+'...' : d.nome),
            datasets: [{
                label: 'Retiradas',
                data: g.top_distribuidores.map(d => d.total),
                backgroundColor: ['#053462', '#0a4a8a', '#1a5f9e', '#2a74b2', '#3a89c6'],
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: {
                x: { beginAtZero: true, ticks: { stepSize: 1 } }
            }
        }
    });

    // Carregar gr√°ficos de reembolsos
    loadReembolsosCharts();
}

// Gr√°ficos de Reembolsos
async function loadReembolsosCharts(){
    const d = await api('/admin/reembolsos/dashboard/graficos');
    if(!d || !d.dados) return;
    const g = d.dados;

    // Destruir gr√°ficos existentes
    if(chartReembolsosMes) chartReembolsosMes.destroy();
    if(chartReembolsosStatus) chartReembolsosStatus.destroy();
    if(chartReembolsosValor) chartReembolsosValor.destroy();
    if(chartReembolsosDist) chartReembolsosDist.destroy();

    // Gr√°fico 1: Reembolsos por M√™s (Barras)
    const ctxMes = document.getElementById('chartReembolsosMes').getContext('2d');
    chartReembolsosMes = new Chart(ctxMes, {
        type: 'bar',
        data: {
            labels: g.reembolsos_por_mes.map(m => m.mes_nome),
            datasets: [{
                label: 'Reembolsos',
                data: g.reembolsos_por_mes.map(m => m.total),
                backgroundColor: 'rgba(220, 62, 49, 0.8)',
                borderColor: '#DC3E31',
                borderWidth: 1,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, ticks: { stepSize: 1 } }
            }
        }
    });

    // Gr√°fico 2: Status dos Reembolsos (Pizza)
    const ctxStatus = document.getElementById('chartReembolsosStatus').getContext('2d');
    chartReembolsosStatus = new Chart(ctxStatus, {
        type: 'doughnut',
        data: {
            labels: ['A Validar', 'Aprovados', 'Pagos', 'Rejeitados'],
            datasets: [{
                data: [
                    g.status_reembolsos.a_validar || 0,
                    g.status_reembolsos.aprovado || 0,
                    g.status_reembolsos.pago || 0,
                    g.status_reembolsos.rejeitado || 0
                ],
                backgroundColor: ['#f59e0b', '#10b981', '#053462', '#ef4444'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom', labels: { padding: 20 } }
            }
        }
    });

    // Gr√°fico 3: Valor Total por M√™s (Linha)
    const ctxValor = document.getElementById('chartReembolsosValor').getContext('2d');
    chartReembolsosValor = new Chart(ctxValor, {
        type: 'line',
        data: {
            labels: g.valores_por_mes.map(m => m.mes_nome),
            datasets: [{
                label: 'Valor Total (R$)',
                data: g.valores_por_mes.map(m => m.valor),
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#10b981',
                pointRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { callback: v => 'R$ ' + v.toLocaleString('pt-BR') }
                }
            }
        }
    });

    // Gr√°fico 4: Top Distribuidores por Reembolso (Barras Horizontais)
    const ctxDist = document.getElementById('chartReembolsosDist').getContext('2d');
    chartReembolsosDist = new Chart(ctxDist, {
        type: 'bar',
        data: {
            labels: g.top_distribuidores.map(d => d.nome.length > 20 ? d.nome.substring(0,20)+'...' : d.nome),
            datasets: [{
                label: 'Valor (R$)',
                data: g.top_distribuidores.map(d => d.valor_total),
                backgroundColor: ['#DC3E31', '#e85a4f', '#ef7b72', '#f69b95', '#fdbbb8'],
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: { callback: v => 'R$ ' + v.toLocaleString('pt-BR') }
                }
            }
        }
    });
}

// Colaboradores - CORRIGIDO filtro "Todos"
async function loadColabs(){
    const b=document.getElementById('searchColab').value;
    const a=document.getElementById('filterAtivo').value;
    // Monta URL corretamente - s√≥ adiciona ativo se tiver valor
    let url = `/admin/colaboradores?busca=${encodeURIComponent(b)}&limite=100`;
    if(a !== '') url += `&ativo=${a}`;
    
    const d=await api(url);
    if(!d||!d.dados)return;
    
    if(d.dados.length===0){
        document.getElementById('tableColabs').innerHTML='<div class="empty-state"><p>Nenhum colaborador encontrado</p></div>';
        return;
    }
    
    document.getElementById('tableColabs').innerHTML=`
        <table>
            <thead><tr><th>Nome</th><th>CPF</th><th>Email</th><th>Cidade/UF</th><th>Status</th><th>A√ß√µes</th></tr></thead>
            <tbody>${d.dados.map(c=>`
                <tr>
                    <td><strong>${c.nome}</strong></td>
                    <td>${formatCPF(c.cpf)}</td>
                    <td>${c.email}</td>
                    <td>${c.cidade}/${c.estado}</td>
                    <td><span class="badge ${c.ativo?'badge-success':'badge-danger'}">${c.ativo?'Ativo':'Inativo'}</span></td>
                    <td class="table-actions">
                        <button class="btn btn-sm btn-outline" onclick="editColab(${c.id})" title="Editar">Editar</button>
                        <button class="btn btn-sm btn-warning" onclick="resetPwdColab(${c.id},'${c.nome.replace(/'/g, "\\'")}')">Senha</button>
                        <button class="btn btn-sm ${c.ativo?'btn-danger':'btn-success'}" onclick="toggleColab(${c.id},${c.ativo?0:1})">${c.ativo?'Desativar':'Ativar'}</button>
                        <button class="btn btn-sm btn-icon" onclick="excluirColab(${c.id},'${c.nome.replace(/'/g, "\\'")}')" title="Excluir permanentemente" style="color:var(--danger)">üóëÔ∏è</button>
                    </td>
                </tr>`).join('')}
            </tbody>
        </table>
        <p style="margin-top: 12px; font-size: 13px; color: var(--text-secondary);">Total: ${d.paginacao.total} colaboradores</p>`;
}

// Toggle Ativo/Inativo Colaborador
async function toggleColab(id, novoStatus){
    const acao = novoStatus ? 'ativar' : 'desativar';
    if(!confirm(`Deseja ${acao} este colaborador?`))return;
    const d=await api(`/admin/colaboradores/${id}`,{method:'PUT',body:JSON.stringify({ativo:novoStatus===1})});
    if(d&&d.sucesso){alert('Status alterado com sucesso!');loadColabs();}
    else alert(d?.erro||'Erro ao alterar status');
}

// Excluir Colaborador (desativa permanentemente)
async function excluirColab(id, nome){
    if(!confirm(`‚ö†Ô∏è ATEN√á√ÉO!\n\nDeseja realmente excluir o colaborador "${nome}"?\n\nEsta a√ß√£o ir√° desativar o colaborador permanentemente.`))return;
    const d=await api(`/admin/colaboradores/${id}`,{method:'DELETE'});
    if(d&&d.sucesso){alert('‚úÖ Colaborador exclu√≠do com sucesso!');loadColabs();loadDash();}
    else alert(d?.erro||'Erro ao excluir colaborador');
}

// Distribuidores
async function loadDists(){
    const b=document.getElementById('searchDist').value;
    const d=await api(`/admin/distribuidores?busca=${encodeURIComponent(b)}&limite=100`);
    if(!d||!d.dados)return;
    
    if(d.dados.length===0){
        document.getElementById('tableDists').innerHTML='<div class="empty-state"><p>Nenhum distribuidor encontrado</p></div>';
        return;
    }
    
    document.getElementById('tableDists').innerHTML=`
        <table>
            <thead><tr><th>Nome</th><th>CNPJ</th><th>Cidade/UF</th><th>Respons√°vel</th><th>Status</th><th>A√ß√µes</th></tr></thead>
            <tbody>${d.dados.map(x=>`
                <tr>
                    <td><strong>${x.nome}</strong></td>
                    <td>${formatCNPJ(x.cnpj)}</td>
                    <td>${x.cidade}/${x.estado}</td>
                    <td>${x.responsavel}</td>
                    <td><span class="badge ${x.ativo?'badge-success':'badge-danger'}">${x.ativo?'Ativo':'Inativo'}</span></td>
                    <td class="table-actions">
                        <button class="btn btn-sm btn-outline" onclick="editDist(${x.id})">Editar</button>
                        <button class="btn btn-sm btn-warning" onclick="resetPwdDist(${x.id},'${x.nome.replace(/'/g, "\\'")}')">Senha</button>
                        <button class="btn btn-sm ${x.ativo?'btn-danger':'btn-success'}" onclick="toggleDist(${x.id},${x.ativo?0:1})">${x.ativo?'Desativar':'Ativar'}</button>
                        <button class="btn btn-sm btn-icon" onclick="excluirDist(${x.id},'${x.nome.replace(/'/g, "\\'")}')" title="Excluir permanentemente" style="color:var(--danger)">üóëÔ∏è</button>
                    </td>
                </tr>`).join('')}
            </tbody>
        </table>`;
}

async function toggleDist(id, novoStatus){
    const acao = novoStatus ? 'ativar' : 'desativar';
    if(!confirm(`Deseja ${acao} este distribuidor?`))return;
    const d=await api(`/admin/distribuidores/${id}`,{method:'PUT',body:JSON.stringify({ativo:novoStatus===1})});
    if(d&&d.sucesso){alert('Status alterado!');loadDists();}
    else alert(d?.erro||'Erro');
}

// Excluir Distribuidor
async function excluirDist(id, nome){
    if(!confirm(`‚ö†Ô∏è ATEN√á√ÉO!\n\nDeseja realmente excluir o distribuidor "${nome}"?\n\nEsta a√ß√£o ir√° desativar o distribuidor permanentemente.`))return;
    const d=await api(`/admin/distribuidores/${id}`,{method:'DELETE'});
    if(d&&d.sucesso){alert('‚úÖ Distribuidor exclu√≠do com sucesso!');loadDists();loadDash();}
    else alert(d?.erro||'Erro ao excluir distribuidor');
}

// Vales
let colabsParaVale = [];

async function loadVales(){
    const m=document.getElementById('filterMes').value;
    const st=document.getElementById('filterStatus').value;
    const d=await api(`/admin/vales?mes=${m}&status=${st}&limite=200`);
    if(!d||!d.dados)return;
    
    const sb={'ativo':'badge-success','utilizado':'badge-warning','expirado':'badge-danger'};
    const total = d.paginacao && d.paginacao.total ? d.paginacao.total : d.dados.length;
    document.getElementById('tableVales').innerHTML=d.dados.length?`
        <table>
            <thead><tr><th>Colaborador</th><th>CPF</th><th>C√≥digo</th><th>Status</th><th>Distribuidor</th><th>Data Retirada</th></tr></thead>
            <tbody>${d.dados.map(v=>`
                <tr>
                    <td>${v.colaborador_nome}</td>
                    <td>${formatCPF(v.colaborador_cpf)}</td>
                    <td><code style="background:var(--gray-100);padding:4px 8px;border-radius:4px;font-weight:600;">${v.codigo}</code></td>
                    <td><span class="badge ${sb[v.status]}">${v.status}</span></td>
                    <td>${v.distribuidor_nome||'-'}</td>
                    <td>${v.data_retirada?new Date(v.data_retirada).toLocaleString('pt-BR'):'-'}</td>
                </tr>`).join('')}
            </tbody>
        </table>
        <p style="margin-top: 12px; font-size: 13px; color: var(--text-secondary);">Total: ${total} vales</p>`:
        '<div class="empty-state"><p>Nenhum vale encontrado</p></div>';
}

async function abrirModalGerarVales(){
    // Resetar estado
    document.querySelector('input[name="tipoGeracao"][value="todos"]').checked = true;
    document.getElementById('selecaoColabs').style.display = 'none';
    document.getElementById('qtdSelecionados').textContent = 'Todos os colaboradores ativos ser√£o contemplados';
    document.getElementById('buscaColabVale').value = '';
    document.getElementById('selecionarTodosColabs').checked = false;
    
    // Carregar colaboradores ativos
    const d = await api('/admin/colaboradores?ativo=true&limite=500');
    if(!d || !d.dados) return;
    
    colabsParaVale = d.dados.map(c => ({...c, selecionado: false}));
    renderColabsVale();
    
    document.getElementById('modalVales').classList.add('show');
}

function renderColabsVale(){
    const busca = document.getElementById('buscaColabVale').value.toLowerCase();
    const filtrados = colabsParaVale.filter(c => 
        c.nome.toLowerCase().includes(busca) || 
        c.cpf.includes(busca) ||
        (c.matricula && c.matricula.toLowerCase().includes(busca))
    );
    
    document.getElementById('listaColabsVale').innerHTML = filtrados.length ? filtrados.map(c => `
        <label style="display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid var(--gray-100);cursor:pointer;transition:background 0.2s" 
               onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='transparent'">
            <input type="checkbox" ${c.selecionado ? 'checked' : ''} onchange="toggleColabVale(${c.id})">
            <div style="flex:1">
                <strong style="font-size:14px">${c.nome}</strong>
                <span style="color:var(--text-secondary);font-size:12px;margin-left:8px">${formatCPF(c.cpf)}</span>
                ${c.matricula ? `<span style="color:var(--gray-400);font-size:11px;margin-left:8px">#${c.matricula}</span>` : ''}
            </div>
        </label>
    `).join('') : '<p style="text-align:center;color:var(--text-secondary);padding:20px">Nenhum colaborador encontrado</p>';
    
    atualizarResumoSelecao();
}

function filtrarColabsVale(){
    renderColabsVale();
}

function toggleColabVale(id){
    const c = colabsParaVale.find(x => x.id === id);
    if(c) c.selecionado = !c.selecionado;
    atualizarResumoSelecao();
}

function toggleTodosColabs(){
    const checked = document.getElementById('selecionarTodosColabs').checked;
    const busca = document.getElementById('buscaColabVale').value.toLowerCase();
    colabsParaVale.forEach(c => {
        if(c.nome.toLowerCase().includes(busca) || c.cpf.includes(busca)){
            c.selecionado = checked;
        }
    });
    renderColabsVale();
}

function toggleSelecaoColabs(){
    const tipo = document.querySelector('input[name="tipoGeracao"]:checked').value;
    document.getElementById('selecaoColabs').style.display = tipo === 'selecionados' ? 'block' : 'none';
    atualizarResumoSelecao();
}

function atualizarResumoSelecao(){
    const tipo = document.querySelector('input[name="tipoGeracao"]:checked').value;
    const el = document.getElementById('qtdSelecionados');
    
    if(tipo === 'todos'){
        el.innerHTML = `<strong>${colabsParaVale.length}</strong> colaboradores ativos ser√£o contemplados`;
    } else {
        const qtd = colabsParaVale.filter(c => c.selecionado).length;
        el.innerHTML = qtd > 0 
            ? `<strong>${qtd}</strong> colaborador${qtd > 1 ? 'es' : ''} selecionado${qtd > 1 ? 's' : ''}`
            : '<span style="color:var(--danger)">Nenhum colaborador selecionado</span>';
    }
}

async function executarGeracaoVales(){
    const tipo = document.querySelector('input[name="tipoGeracao"]:checked').value;
    
    if(tipo === 'todos'){
        if(!confirm('Gerar vales para TODOS os colaboradores ativos do m√™s atual?\n\nColaboradores que j√° possuem vale no m√™s ser√£o ignorados.')) return;
        
        const d = await api('/admin/vales/gerar-mensal', {method:'POST'});
        if(d && d.sucesso){
            alert(`‚úÖ ${d.gerados} vales gerados com sucesso!`);
            closeModal('vales');
            loadVales();
            loadDash();
        } else {
            alert(d?.erro || 'Erro ao gerar vales');
        }
    } else {
        const selecionados = colabsParaVale.filter(c => c.selecionado);
        if(selecionados.length === 0){
            alert('Selecione pelo menos um colaborador!');
            return;
        }
        
        if(!confirm(`Gerar vales para ${selecionados.length} colaborador${selecionados.length > 1 ? 'es' : ''}?`)) return;
        
        // Gerar para cada colaborador selecionado
        let gerados = 0, erros = 0;
        for(const c of selecionados){
            const d = await api('/admin/vales/gerar', {
                method: 'POST',
                body: JSON.stringify({ colaborador_id: c.id })
            });
            if(d && d.sucesso) gerados++;
            else erros++;
        }
        
        if(erros > 0){
            alert(`‚úÖ ${gerados} vales gerados\n‚ö†Ô∏è ${erros} colaboradores j√° tinham vale no m√™s`);
        } else {
            alert(`‚úÖ ${gerados} vales gerados com sucesso!`);
        }
        closeModal('vales');
        loadVales();
        loadDash();
    }
}

// Solicita√ß√µes
let filtroSolicAtual = 'pendente';

async function loadSolic(status = 'pendente'){
    filtroSolicAtual = status;
    
    // Atualizar bot√µes
    document.getElementById('btnSolicPendente').className = status === 'pendente' ? 'btn btn-sm btn-primary' : 'btn btn-sm btn-outline';
    document.getElementById('btnSolicAprovado').className = status === 'aprovado' ? 'btn btn-sm btn-success' : 'btn btn-sm btn-outline';
    document.getElementById('btnSolicRejeitado').className = status === 'rejeitado' ? 'btn btn-sm btn-danger' : 'btn btn-sm btn-outline';
    
    const d=await api(`/admin/solicitacoes?status=${status}&limite=50`);
    if(!d||!d.dados)return;
    
    const mostrarAcoes = status === 'pendente';
    
    document.getElementById('tableSolic').innerHTML=d.dados.length?`
        <table>
            <thead><tr><th>Colaborador</th><th>Tipo</th><th>Descri√ß√£o</th><th>Data</th>${mostrarAcoes ? '<th>A√ß√µes</th>' : '<th>Resposta</th>'}</tr></thead>
            <tbody>${d.dados.map(s=>`
                <tr>
                    <td><strong>${s.colaborador_nome}</strong></td>
                    <td><span class="badge badge-info">${s.tipo}</span></td>
                    <td>${s.descricao}</td>
                    <td>${new Date(s.criado_em).toLocaleDateString('pt-BR')}</td>
                    ${mostrarAcoes ? `
                        <td class="table-actions">
                            <button class="btn btn-sm btn-success" onclick="respSolic(${s.id},'aprovado')">Aprovar</button>
                            <button class="btn btn-sm btn-danger" onclick="respSolic(${s.id},'rejeitado')">Rejeitar</button>
                        </td>
                    ` : `
                        <td>${s.resposta_admin || '-'}</td>
                    `}
                </tr>`).join('')}
            </tbody>
        </table>`:
        `<div class="empty-state"><p>Nenhuma solicita√ß√£o ${status === 'pendente' ? 'pendente üéâ' : status === 'aprovado' ? 'aprovada' : 'rejeitada'}</p></div>`;
}

async function respSolic(id,st){
    const resp=prompt('Observa√ß√£o (opcional):');
    const d=await api(`/admin/solicitacoes/${id}`,{method:'PUT',body:JSON.stringify({status:st,resposta_admin:resp||''})});
    if(d&&d.sucesso){alert('Solicita√ß√£o respondida!');loadSolic(filtroSolicAtual);loadDash();}
}

// Relat√≥rios
let dadosRelatorioAtual = null;

async function genReport(){
    const ini=document.getElementById('relIni').value;
    const fim=document.getElementById('relFim').value;
    const d=await api(`/admin/relatorios/retiradas?mes_inicio=${ini}&mes_fim=${fim}`);
    if(!d||!d.dados)return;
    
    dadosRelatorioAtual = d.dados;
    dadosRelatorioAtual.periodo = {inicio: ini, fim: fim};
    
    document.getElementById('reportOut').innerHTML=d.dados.resumo.length?`
        <h4 style="margin-bottom: 16px; font-size: 16px;">Resumo por Distribuidor</h4>
        <table>
            <thead><tr><th>Distribuidor</th><th>Total de Retiradas</th></tr></thead>
            <tbody>${d.dados.resumo.map(r=>`<tr><td>${r.distribuidor_nome}</td><td><span class="badge badge-info">${r.total_retiradas}</span></td></tr>`).join('')}</tbody>
        </table>
        <p style="margin-top: 16px; font-size: 16px; font-weight: 600;">Total geral: ${d.dados.total} retiradas</p>`:
        '<div class="empty-state"><p>Nenhum dado para o per√≠odo selecionado</p></div>';
    
    // Mostrar bot√µes de exporta√ß√£o se houver dados
    document.getElementById('reportActions').style.display = d.dados.resumo.length ? 'block' : 'none';
}

// ==================== FUN√á√ïES DE EXPORTA√á√ÉO ====================

function exportarRelatorioExcel(){
    if(!dadosRelatorioAtual || !dadosRelatorioAtual.detalhes.length){
        alert('Gere o relat√≥rio primeiro!');
        return;
    }
    
    const dados = dadosRelatorioAtual.detalhes.map(r => ({
        'Data': new Date(r.data_retirada).toLocaleDateString('pt-BR'),
        'Hora': new Date(r.data_retirada).toLocaleTimeString('pt-BR'),
        'Colaborador': r.colaborador_nome,
        'CPF': r.colaborador_cpf,
        'C√≥digo Vale': r.codigo,
        'Distribuidor': r.distribuidor_nome,
        'M√™s Refer√™ncia': r.mes_referencia
    }));
    
    const ws = XLSX.utils.json_to_sheet(dados);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Retiradas');
    
    // Ajustar largura das colunas
    ws['!cols'] = [
        {wch: 12}, {wch: 10}, {wch: 30}, {wch: 15}, 
        {wch: 12}, {wch: 25}, {wch: 12}
    ];
    
    const fileName = `relatorio_retiradas_${dadosRelatorioAtual.periodo.inicio}_${dadosRelatorioAtual.periodo.fim}.xlsx`;
    XLSX.writeFile(wb, fileName);
}

function exportarRelatorioPDF(){
    if(!dadosRelatorioAtual || !dadosRelatorioAtual.detalhes.length){
        alert('Gere o relat√≥rio primeiro!');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Cabe√ßalho
    doc.setFontSize(18);
    doc.setTextColor(5, 52, 98);
    doc.text('Relat√≥rio de Retiradas - Vale-G√°s', 14, 20);
    
    doc.setFontSize(11);
    doc.setTextColor(100);
    doc.text(`Per√≠odo: ${dadosRelatorioAtual.periodo.inicio} a ${dadosRelatorioAtual.periodo.fim}`, 14, 28);
    doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 14, 34);
    
    // Resumo por distribuidor
    doc.setFontSize(14);
    doc.setTextColor(0);
    doc.text('Resumo por Distribuidor', 14, 46);
    
    doc.autoTable({
        startY: 50,
        head: [['Distribuidor', 'Total de Retiradas']],
        body: dadosRelatorioAtual.resumo.map(r => [r.distribuidor_nome, r.total_retiradas]),
        theme: 'striped',
        headStyles: { fillColor: [5, 52, 98] },
        foot: [['TOTAL', dadosRelatorioAtual.total]],
        footStyles: { fillColor: [240, 240, 240], textColor: [0, 0, 0], fontStyle: 'bold' }
    });
    
    // Detalhes (nova p√°gina se necess√°rio)
    doc.addPage();
    doc.setFontSize(14);
    doc.text('Detalhamento das Retiradas', 14, 20);
    
    doc.autoTable({
        startY: 26,
        head: [['Data', 'Colaborador', 'CPF', 'C√≥digo', 'Distribuidor']],
        body: dadosRelatorioAtual.detalhes.map(r => [
            new Date(r.data_retirada).toLocaleDateString('pt-BR'),
            r.colaborador_nome.substring(0, 25),
            r.colaborador_cpf,
            r.codigo,
            r.distribuidor_nome.substring(0, 20)
        ]),
        theme: 'striped',
        headStyles: { fillColor: [5, 52, 98] },
        styles: { fontSize: 8 }
    });
    
    const fileName = `relatorio_retiradas_${dadosRelatorioAtual.periodo.inicio}_${dadosRelatorioAtual.periodo.fim}.pdf`;
    doc.save(fileName);
}

async function exportarColaboradoresExcel(){
    const status = document.getElementById('expColabStatus').value;
    let url = '/admin/colaboradores?limite=1000';
    if(status) url += `&ativo=${status}`;
    
    const d = await api(url);
    if(!d || !d.dados || !d.dados.length){
        alert('Nenhum colaborador encontrado!');
        return;
    }
    
    const dados = d.dados.map(c => ({
        'Nome': c.nome,
        'CPF': c.cpf,
        'Email': c.email,
        'Telefone': c.telefone,
        'Cidade': c.cidade,
        'UF': c.estado,
        'Data Admiss√£o': c.data_admissao,
        'Matr√≠cula': c.matricula || '',
        'Setor': c.setor || '',
        'Status': c.ativo ? 'Ativo' : 'Inativo'
    }));
    
    const ws = XLSX.utils.json_to_sheet(dados);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Colaboradores');
    
    ws['!cols'] = [
        {wch: 30}, {wch: 14}, {wch: 30}, {wch: 15}, 
        {wch: 20}, {wch: 5}, {wch: 12}, {wch: 12}, {wch: 15}, {wch: 10}
    ];
    
    XLSX.writeFile(wb, `colaboradores_${new Date().toISOString().split('T')[0]}.xlsx`);
}

async function exportarColaboradoresPDF(){
    const status = document.getElementById('expColabStatus').value;
    let url = '/admin/colaboradores?limite=1000';
    if(status) url += `&ativo=${status}`;
    
    const d = await api(url);
    if(!d || !d.dados || !d.dados.length){
        alert('Nenhum colaborador encontrado!');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape');
    
    doc.setFontSize(18);
    doc.setTextColor(5, 52, 98);
    doc.text('Lista de Colaboradores - Vale-G√°s', 14, 20);
    
    doc.setFontSize(11);
    doc.setTextColor(100);
    doc.text(`Total: ${d.dados.length} colaboradores | Gerado em: ${new Date().toLocaleString('pt-BR')}`, 14, 28);
    
    doc.autoTable({
        startY: 34,
        head: [['Nome', 'CPF', 'Email', 'Telefone', 'Cidade/UF', 'Status']],
        body: d.dados.map(c => [
            c.nome.substring(0, 30),
            c.cpf,
            c.email.substring(0, 25),
            c.telefone,
            `${c.cidade}/${c.estado}`,
            c.ativo ? 'Ativo' : 'Inativo'
        ]),
        theme: 'striped',
        headStyles: { fillColor: [5, 52, 98] },
        styles: { fontSize: 8 }
    });
    
    doc.save(`colaboradores_${new Date().toISOString().split('T')[0]}.pdf`);
}

async function exportarValesExcel(){
    const mes = document.getElementById('expValesMes').value;
    const status = document.getElementById('expValesStatus').value;
    
    let url = `/admin/vales?mes=${mes}&limite=1000`;
    if(status) url += `&status=${status}`;
    
    const d = await api(url);
    if(!d || !d.dados || !d.dados.length){
        alert('Nenhum vale encontrado!');
        return;
    }
    
    const dados = d.dados.map(v => ({
        'Colaborador': v.colaborador_nome,
        'CPF': v.colaborador_cpf,
        'C√≥digo': v.codigo,
        'Status': v.status,
        'M√™s Refer√™ncia': v.mes_referencia,
        'Distribuidor': v.distribuidor_nome || '-',
        'Data Retirada': v.data_retirada ? new Date(v.data_retirada).toLocaleString('pt-BR') : '-'
    }));
    
    const ws = XLSX.utils.json_to_sheet(dados);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Vales');
    
    ws['!cols'] = [
        {wch: 30}, {wch: 14}, {wch: 12}, {wch: 12}, 
        {wch: 12}, {wch: 25}, {wch: 18}
    ];
    
    XLSX.writeFile(wb, `vales_${mes}.xlsx`);
}

async function exportarValesPDF(){
    const mes = document.getElementById('expValesMes').value;
    const status = document.getElementById('expValesStatus').value;
    
    let url = `/admin/vales?mes=${mes}&limite=1000`;
    if(status) url += `&status=${status}`;
    
    const d = await api(url);
    if(!d || !d.dados || !d.dados.length){
        alert('Nenhum vale encontrado!');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(18);
    doc.setTextColor(5, 52, 98);
    doc.text(`Vales-G√°s - ${mes}`, 14, 20);
    
    doc.setFontSize(11);
    doc.setTextColor(100);
    doc.text(`Total: ${d.dados.length} vales | Gerado em: ${new Date().toLocaleString('pt-BR')}`, 14, 28);
    
    // Resumo por status
    const ativos = d.dados.filter(v => v.status === 'ativo').length;
    const utilizados = d.dados.filter(v => v.status === 'utilizado').length;
    const expirados = d.dados.filter(v => v.status === 'expirado').length;
    doc.text(`Ativos: ${ativos} | Utilizados: ${utilizados} | Expirados: ${expirados}`, 14, 34);
    
    doc.autoTable({
        startY: 42,
        head: [['Colaborador', 'CPF', 'C√≥digo', 'Status', 'Distribuidor', 'Data Retirada']],
        body: d.dados.map(v => [
            v.colaborador_nome.substring(0, 25),
            v.colaborador_cpf,
            v.codigo,
            v.status,
            v.distribuidor_nome?.substring(0, 18) || '-',
            v.data_retirada ? new Date(v.data_retirada).toLocaleDateString('pt-BR') : '-'
        ]),
        theme: 'striped',
        headStyles: { fillColor: [5, 52, 98] },
        styles: { fontSize: 8 }
    });
    
    doc.save(`vales_${mes}.pdf`);
}

// Modal functions
function openModal(t){
    const form = document.getElementById('form'+(t==='colab'?'Colab':'Dist'));
    form.reset();
    document.getElementById(t==='colab'?'cId':'dId').value='';
    document.getElementById('modal'+(t==='colab'?'Colab':'Dist')+'T').textContent='Novo '+(t==='colab'?'Colaborador':'Distribuidor');
    document.getElementById(t==='colab'?'senhaGerada':'senhaDist').style.display='none';
    // Mostrar dados banc√°rios se for distribuidor (padr√£o √© externo)
    if(t==='dist') toggleDadosBancarios();
    document.getElementById('modal'+(t==='colab'?'Colab':'Dist')).classList.add('show');
}
function closeModal(t){
    const modalMap = {
        'colab':'modalColab',
        'dist':'modalDist',
        'vales':'modalVales',
        'usuario':'modalUsuario',
        'senha':'modalSenha',
        'importacao':'modalImportacao',
        'reembolso':'modalReembolso',
        'aprovarReembolso':'modalAprovarReembolso',
        'rejeitarReembolso':'modalRejeitarReembolso',
        'marcarPago':'modalMarcarPago',
        'novoReembolso':'modalNovoReembolso',
        'importDist':'modalImportDist'
    };
    if(modalMap[t]) document.getElementById(modalMap[t]).classList.remove('show');
}

// Fun√ß√£o gen√©rica para abrir modais pelo ID
function abrirModalPorId(modalId) {
    const modal = document.getElementById(modalId);
    if(modal) modal.classList.add('show');
}

// Fun√ß√£o para exibir modal de senha (substitui alert)
function mostrarSenhaModal(nome, senha){
    document.getElementById('senhaUsuarioNome').textContent = nome;
    document.getElementById('senhaGeradaValor').textContent = senha;
    document.getElementById('modalSenha').classList.add('show');
}

function copiarSenha(){
    const senha = document.getElementById('senhaGeradaValor').textContent;
    navigator.clipboard.writeText(senha).then(() => {
        alert('Senha copiada para a √°rea de transfer√™ncia!');
    });
}

// Edit Colaborador
async function editColab(id){
    const d=await api(`/admin/colaboradores/${id}`);
    if(!d||!d.dados)return;
    const c=d.dados;
    document.getElementById('cId').value=c.id;
    document.getElementById('cNome').value=c.nome;
    document.getElementById('cCpf').value=formatCPF(c.cpf);
    document.getElementById('cEmail').value=c.email;
    document.getElementById('cTel').value=c.telefone;
    document.getElementById('cMat').value=c.matricula||'';
    document.getElementById('cSetor').value=c.setor||'';
    document.getElementById('cAdm').value=c.data_admissao;
    document.getElementById('cCep').value=c.cep;
    document.getElementById('cLog').value=c.logradouro;
    document.getElementById('cNum').value=c.numero;
    document.getElementById('cComp').value=c.complemento||'';
    document.getElementById('cBairro').value=c.bairro;
    document.getElementById('cCidade').value=c.cidade;
    document.getElementById('cUF').value=c.estado;
    document.getElementById('modalColabT').textContent='Editar Colaborador';
    document.getElementById('senhaGerada').style.display='none';
    document.getElementById('modalColab').classList.add('show');
}

// Toggle dados banc√°rios baseado no tipo de distribuidor
function toggleDadosBancarios() {
    const tipo = document.getElementById('dTipo').value;
    document.getElementById('dadosBancarios').style.display = tipo === 'externo' ? 'block' : 'none';
}

// Edit Distribuidor
async function editDist(id){
    const d=await api(`/admin/distribuidores/${id}`);
    if(!d||!d.dados)return;
    const x=d.dados;
    document.getElementById('dId').value=x.id;
    document.getElementById('dNome').value=x.nome;
    document.getElementById('dCnpj').value=formatCNPJ(x.cnpj);
    document.getElementById('dEmail').value=x.email;
    document.getElementById('dTel').value=x.telefone;
    document.getElementById('dResp').value=x.responsavel;
    document.getElementById('dHor').value=x.horario_funcionamento||'';
    document.getElementById('dTipo').value=x.tipo_distribuidor||'externo';
    document.getElementById('dCep').value=x.cep;
    document.getElementById('dLog').value=x.logradouro;
    document.getElementById('dNum').value=x.numero;
    document.getElementById('dComp').value=x.complemento||'';
    document.getElementById('dBairro').value=x.bairro;
    document.getElementById('dCidade').value=x.cidade;
    document.getElementById('dUF').value=x.estado;
    // Dados banc√°rios
    document.getElementById('dBanco').value=x.banco||'';
    document.getElementById('dAgencia').value=x.agencia||'';
    document.getElementById('dConta').value=x.conta||'';
    document.getElementById('dTipoConta').value=x.tipo_conta||'';
    document.getElementById('dPix').value=x.pix||'';
    toggleDadosBancarios();
    document.getElementById('modalDistT').textContent='Editar Distribuidor';
    document.getElementById('senhaDist').style.display='none';
    document.getElementById('modalDist').classList.add('show');
}

// Form Submit Colaborador
document.getElementById('formColab').onsubmit=async e=>{
    e.preventDefault();
    const id=document.getElementById('cId').value;
    const dados={
        nome:document.getElementById('cNome').value,
        cpf:document.getElementById('cCpf').value.replace(/\D/g,''),
        email:document.getElementById('cEmail').value,
        telefone:document.getElementById('cTel').value,
        matricula:document.getElementById('cMat').value,
        setor:document.getElementById('cSetor').value,
        data_admissao:document.getElementById('cAdm').value,
        cep:document.getElementById('cCep').value,
        logradouro:document.getElementById('cLog').value,
        numero:document.getElementById('cNum').value,
        complemento:document.getElementById('cComp').value,
        bairro:document.getElementById('cBairro').value,
        cidade:document.getElementById('cCidade').value,
        estado:document.getElementById('cUF').value.toUpperCase()
    };
    const d=await api(id?`/admin/colaboradores/${id}`:'/admin/colaboradores',{method:id?'PUT':'POST',body:JSON.stringify(dados)});
    if(d&&(d.sucesso||d.id)){
        if(!id && d.senha_temporaria){
            document.getElementById('senhaValor').textContent=d.senha_temporaria;
            document.getElementById('senhaGerada').style.display='block';
            alert('Colaborador criado! A senha est√° vis√≠vel no formul√°rio.');
        }else{
            alert(id?'Colaborador atualizado!':'Colaborador criado!');
            closeModal('colab');
        }
        loadColabs();
    }else{
        alert(d?.erro||'Erro ao salvar');
    }
};

// Form Submit Distribuidor
document.getElementById('formDist').onsubmit=async e=>{
    e.preventDefault();
    const id=document.getElementById('dId').value;
    const tipo=document.getElementById('dTipo').value;
    const dados={
        nome:document.getElementById('dNome').value,
        cnpj:document.getElementById('dCnpj').value.replace(/\D/g,''),
        email:document.getElementById('dEmail').value,
        telefone:document.getElementById('dTel').value,
        responsavel:document.getElementById('dResp').value,
        horario_funcionamento:document.getElementById('dHor').value,
        tipo_distribuidor:tipo,
        cep:document.getElementById('dCep').value,
        logradouro:document.getElementById('dLog').value,
        numero:document.getElementById('dNum').value,
        complemento:document.getElementById('dComp').value,
        bairro:document.getElementById('dBairro').value,
        cidade:document.getElementById('dCidade').value,
        estado:document.getElementById('dUF').value.toUpperCase()
    };
    // Adicionar dados banc√°rios se for distribuidor externo
    if(tipo === 'externo'){
        dados.banco = document.getElementById('dBanco').value;
        dados.agencia = document.getElementById('dAgencia').value;
        dados.conta = document.getElementById('dConta').value;
        dados.tipo_conta = document.getElementById('dTipoConta').value;
        dados.pix = document.getElementById('dPix').value;
    }
    const d=await api(id?`/admin/distribuidores/${id}`:'/admin/distribuidores',{method:id?'PUT':'POST',body:JSON.stringify(dados)});
    if(d&&(d.sucesso||d.id)){
        if(!id && d.senha_temporaria){
            document.getElementById('senhaDistValor').textContent=d.senha_temporaria;
            document.getElementById('senhaDist').style.display='block';
            alert('Distribuidor criado! A senha est√° vis√≠vel no formul√°rio.');
        }else{
            alert(id?'Distribuidor atualizado!':'Distribuidor criado!');
            closeModal('dist');
        }
        loadDists();
    }else{
        alert(d?.erro||'Erro ao salvar');
    }
};

// Reset senha com modal melhorado
async function resetPwdColab(id, nome){
    if(!confirm(`Resetar senha do colaborador ${nome}?\n\nUma nova senha ser√° gerada.`))return;
    const d=await api(`/admin/colaboradores/${id}/resetar-senha`,{method:'POST'});
    if(d&&d.sucesso){
        mostrarSenhaModal(nome, d.nova_senha);
    }else alert(d?.erro||'Erro');
}

async function resetPwdDist(id, nome){
    if(!confirm(`Resetar senha do distribuidor ${nome}?`))return;
    const d=await api(`/admin/distribuidores/${id}/resetar-senha`,{method:'POST'});
    if(d&&d.sucesso){
        mostrarSenhaModal(nome, d.nova_senha);
    }else alert(d?.erro||'Erro');
}

// ==================== USU√ÅRIOS RH ====================
async function loadUsuarios(){
    const d = await api('/admin/usuarios');
    if(!d || !d.dados) return;
    
    const nivelBadge = {'admin':'badge-danger','supervisor':'badge-warning','operador':'badge-info'};
    const nivelText = {'admin':'Administrador','supervisor':'Supervisor','operador':'Operador'};
    
    document.getElementById('tableUsuarios').innerHTML = d.dados.length ? `
        <table>
            <thead><tr><th>Nome</th><th>Email</th><th>N√≠vel</th><th>Status</th><th>A√ß√µes</th></tr></thead>
            <tbody>${d.dados.map(u => `
                <tr>
                    <td><strong>${u.nome}</strong>${u.is_master ? ' <span style="color:var(--warning)">‚òÖ</span>' : ''}</td>
                    <td>${u.email}</td>
                    <td><span class="badge ${nivelBadge[u.nivel]}">${nivelText[u.nivel]}</span></td>
                    <td><span class="badge ${u.ativo ? 'badge-success' : 'badge-danger'}">${u.ativo ? 'Ativo' : 'Inativo'}</span></td>
                    <td class="table-actions">
                        <button class="btn btn-sm btn-outline" onclick="editUsuario(${u.id})">Editar</button>
                        ${!u.is_master ? `
                            <button class="btn btn-sm ${u.ativo ? 'btn-danger' : 'btn-success'}" onclick="toggleUsuario(${u.id}, ${u.ativo ? 0 : 1})">${u.ativo ? 'Desativar' : 'Ativar'}</button>
                            <button class="btn btn-sm btn-icon" onclick="excluirUsuario(${u.id},'${u.nome.replace(/'/g, "\\'")}')" title="Excluir permanentemente" style="color:var(--danger)">üóëÔ∏è</button>
                        ` : ''}
                    </td>
                </tr>`).join('')}
            </tbody>
        </table>
        <p style="margin-top: 12px; font-size: 13px; color: var(--text-secondary);">Total: ${d.dados.length} usu√°rios</p>
    ` : '<div class="empty-state"><p>Nenhum usu√°rio cadastrado</p></div>';
}

function openModalUsuario(){
    document.getElementById('formUsuario').reset();
    document.getElementById('uId').value = '';
    document.getElementById('modalUsuarioT').textContent = 'Novo Usu√°rio RH';
    document.getElementById('uSenha').required = true;
    document.getElementById('modalUsuario').classList.add('show');
}

async function editUsuario(id){
    const d = await api(`/admin/usuarios/${id}`);
    if(!d || !d.dados) return;
    const u = d.dados;
    
    document.getElementById('uId').value = u.id;
    document.getElementById('uNome').value = u.nome;
    document.getElementById('uEmail').value = u.email;
    document.getElementById('uNivel').value = u.nivel;
    document.getElementById('uSenha').value = '';
    document.getElementById('uSenha').required = false;
    document.getElementById('modalUsuarioT').textContent = 'Editar Usu√°rio';
    document.getElementById('modalUsuario').classList.add('show');
}

async function salvarUsuario(e){
    e.preventDefault();
    const id = document.getElementById('uId').value;
    const dados = {
        nome: document.getElementById('uNome').value,
        email: document.getElementById('uEmail').value,
        nivel: document.getElementById('uNivel').value
    };
    const senha = document.getElementById('uSenha').value;
    if(senha) dados.senha = senha;
    
    const d = await api(id ? `/admin/usuarios/${id}` : '/admin/usuarios', {
        method: id ? 'PUT' : 'POST',
        body: JSON.stringify(dados)
    });
    
    if(d && (d.sucesso || d.id)){
        alert(id ? 'Usu√°rio atualizado!' : 'Usu√°rio criado!');
        closeModal('usuario');
        loadUsuarios();
    } else {
        alert(d?.erro || 'Erro ao salvar');
    }
}

async function toggleUsuario(id, novoStatus){
    const acao = novoStatus ? 'ativar' : 'desativar';
    if(!confirm(`Deseja ${acao} este usu√°rio?`)) return;
    const d = await api(`/admin/usuarios/${id}`, {
        method: 'PUT',
        body: JSON.stringify({ ativo: novoStatus === 1 })
    });
    if(d && d.sucesso){
        alert('Status alterado!');
        loadUsuarios();
    } else {
        alert(d?.erro || 'Erro');
    }
}

// Excluir Usu√°rio RH
async function excluirUsuario(id, nome){
    if(!confirm(`‚ö†Ô∏è ATEN√á√ÉO!\n\nDeseja realmente excluir o usu√°rio "${nome}"?\n\nEsta a√ß√£o ir√° desativar o usu√°rio permanentemente.`))return;
    const d=await api(`/admin/usuarios/${id}`,{method:'DELETE'});
    if(d&&d.sucesso){alert('‚úÖ Usu√°rio exclu√≠do com sucesso!');loadUsuarios();}
    else alert(d?.erro||'Erro ao excluir usu√°rio');
}

// Solicita√ß√µes de recupera√ß√£o de senha
async function loadSolicSenha(){
    const d = await api('/admin/solicitacoes-senha');
    if(!d || !d.dados) {
        document.getElementById('tableSolicSenha').innerHTML = '<div class="empty-state"><p>Nenhuma solicita√ß√£o pendente</p></div>';
        return;
    }
    
    const tipoBadge = {'colaborador':'badge-success','distribuidor':'badge-info'};
    
    document.getElementById('tableSolicSenha').innerHTML = d.dados.length ? `
        <table>
            <thead><tr><th>Tipo</th><th>Nome</th><th>Email</th><th>Solicitado em</th><th>A√ß√µes</th></tr></thead>
            <tbody>${d.dados.map(s => `
                <tr>
                    <td><span class="badge ${tipoBadge[s.tipo_usuario]}">${s.tipo_usuario}</span></td>
                    <td>${s.nome}</td>
                    <td>${s.email}</td>
                    <td>${new Date(s.criado_em).toLocaleString('pt-BR')}</td>
                    <td class="table-actions">
                        <button class="btn btn-sm btn-success" onclick="aprovarResetSenha('${s.tipo_usuario}', ${s.usuario_id}, '${s.nome}')">Gerar Nova Senha</button>
                        <button class="btn btn-sm btn-danger" onclick="rejeitarResetSenha(${s.id})">Rejeitar</button>
                    </td>
                </tr>`).join('')}
            </tbody>
        </table>
    ` : '<div class="empty-state"><p>Nenhuma solicita√ß√£o pendente üéâ</p></div>';
}

async function aprovarResetSenha(tipo, userId, nome){
    if(!confirm(`Gerar nova senha para ${nome}?`)) return;
    
    const endpoint = tipo === 'colaborador' 
        ? `/admin/colaboradores/${userId}/resetar-senha`
        : `/admin/distribuidores/${userId}/resetar-senha`;
    
    const d = await api(endpoint, { method: 'POST' });
    if(d && d.sucesso){
        mostrarSenhaModal(nome, d.nova_senha);
        loadSolicSenha();
    } else {
        alert(d?.erro || 'Erro ao gerar senha');
    }
}

async function rejeitarResetSenha(id){
    if(!confirm('Rejeitar esta solicita√ß√£o?')) return;
    const d = await api(`/admin/solicitacoes-senha/${id}`, { method: 'DELETE' });
    if(d && d.sucesso){
        alert('Solicita√ß√£o rejeitada');
        loadSolicSenha();
    }
}

// CEP
async function fetchCep(p){
    const cep=document.getElementById(p+'Cep').value.replace(/\D/g,'');
    if(cep.length!==8)return;
    try{
        const d=await fetch('/api/cep/'+cep).then(r=>r.json());
        if(d.sucesso){
            document.getElementById(p+'Log').value=d.dados.logradouro||'';
            document.getElementById(p+'Bairro').value=d.dados.bairro||'';
            document.getElementById(p+'Cidade').value=d.dados.cidade||'';
            document.getElementById(p+'UF').value=d.dados.estado||'';
        }
    }catch(e){}
}

// Formatters
function formatCPF(cpf){
    cpf=cpf.replace(/\D/g,'');
    return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,'$1.$2.$3-$4');
}
function formatCNPJ(cnpj){
    cnpj=cnpj.replace(/\D/g,'');
    return cnpj.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/,'$1.$2.$3/$4-$5');
}

// ==================== IMPORTA√á√ÉO EM MASSA ====================

let dadosImportacao = [];

function abrirModalImportacao(){
    // Reset modal
    document.getElementById('importEtapa1').style.display = 'block';
    document.getElementById('importEtapa2').style.display = 'none';
    document.getElementById('importEtapa3').style.display = 'none';
    document.getElementById('btnConfirmarImport').style.display = 'none';
    document.getElementById('arquivoImportacao').value = '';
    dadosImportacao = [];
    
    document.getElementById('modalImportacao').classList.add('show');
}

function baixarModeloImportacao(){
    // Criar modelo Excel
    const modelo = [
        {
            nome: 'Jo√£o da Silva',
            cpf: '12345678901',
            email: 'joao@email.com',
            telefone: '11999998888',
            cidade: 'S√£o Paulo',
            estado: 'SP',
            data_admissao: '2024-01-15',
            matricula: 'MAT001',
            setor: 'Administrativo'
        },
        {
            nome: 'Maria Santos',
            cpf: '98765432100',
            email: 'maria@email.com',
            telefone: '11988887777',
            cidade: 'Campinas',
            estado: 'SP',
            data_admissao: '2024-02-01',
            matricula: 'MAT002',
            setor: 'Operacional'
        }
    ];
    
    const ws = XLSX.utils.json_to_sheet(modelo);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Colaboradores');
    
    // Ajustar largura das colunas
    ws['!cols'] = [
        {wch: 25}, {wch: 14}, {wch: 25}, {wch: 14}, 
        {wch: 20}, {wch: 5}, {wch: 12}, {wch: 12}, {wch: 15}
    ];
    
    XLSX.writeFile(wb, 'modelo_importacao_colaboradores.xlsx');
}

async function processarArquivoImportacao(input){
    const file = input.files[0];
    if(!file) return;
    
    try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(sheet);
        
        if(!jsonData.length){
            alert('Arquivo vazio ou formato inv√°lido!');
            return;
        }
        
        // Validar e processar dados
        const camposObrigatorios = ['nome', 'cpf', 'email', 'telefone', 'cidade', 'estado', 'data_admissao'];
        const erros = [];
        const validos = [];
        
        jsonData.forEach((row, idx) => {
            const linha = idx + 2; // +2 porque linha 1 √© cabe√ßalho
            const errosLinha = [];
            
            // Verificar campos obrigat√≥rios
            camposObrigatorios.forEach(campo => {
                if(!row[campo] || String(row[campo]).trim() === ''){
                    errosLinha.push(`${campo} vazio`);
                }
            });
            
            // Validar CPF (apenas n√∫meros, 11 d√≠gitos)
            if(row.cpf){
                const cpfLimpo = String(row.cpf).replace(/\D/g, '');
                if(cpfLimpo.length !== 11){
                    errosLinha.push('CPF inv√°lido');
                }
                row.cpf = cpfLimpo;
            }
            
            // Validar email
            if(row.email && !row.email.includes('@')){
                errosLinha.push('Email inv√°lido');
            }
            
            // Validar estado (2 letras)
            if(row.estado && row.estado.length !== 2){
                errosLinha.push('Estado deve ter 2 letras');
            }
            
            // Formatar telefone
            if(row.telefone){
                row.telefone = String(row.telefone).replace(/\D/g, '');
            }
            
            if(errosLinha.length > 0){
                erros.push({ linha, erros: errosLinha, dados: row });
            } else {
                validos.push(row);
            }
        });
        
        dadosImportacao = validos;
        
        // Mostrar preview
        document.getElementById('importEtapa1').style.display = 'none';
        document.getElementById('importEtapa2').style.display = 'block';
        
        // Resumo
        document.getElementById('importResumo').innerHTML = `
            <div style="display:flex;gap:16px;margin-bottom:16px">
                <div style="background:#d1fae5;padding:12px 20px;border-radius:8px;flex:1;text-align:center">
                    <p style="font-size:24px;font-weight:700;color:#059669">${validos.length}</p>
                    <p style="font-size:12px;color:#059669">V√°lidos</p>
                </div>
                <div style="background:${erros.length ? '#fee2e2' : '#f3f4f6'};padding:12px 20px;border-radius:8px;flex:1;text-align:center">
                    <p style="font-size:24px;font-weight:700;color:${erros.length ? '#dc2626' : '#6b7280'}">${erros.length}</p>
                    <p style="font-size:12px;color:${erros.length ? '#dc2626' : '#6b7280'}">Com erros</p>
                </div>
            </div>
            ${erros.length ? `
                <div style="background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:12px;margin-bottom:16px">
                    <p style="font-size:13px;font-weight:600;color:#dc2626;margin-bottom:8px">‚ö†Ô∏è Linhas com erro (ser√£o ignoradas):</p>
                    ${erros.slice(0, 5).map(e => `<p style="font-size:12px;color:#dc2626">Linha ${e.linha}: ${e.erros.join(', ')}</p>`).join('')}
                    ${erros.length > 5 ? `<p style="font-size:12px;color:#dc2626">... e mais ${erros.length - 5} erros</p>` : ''}
                </div>
            ` : ''}
        `;
        
        // Preview dos dados v√°lidos
        if(validos.length > 0){
            document.getElementById('importPreview').innerHTML = `
                <thead><tr><th>Nome</th><th>CPF</th><th>Email</th><th>Cidade/UF</th></tr></thead>
                <tbody>${validos.slice(0, 20).map(v => `
                    <tr>
                        <td>${v.nome}</td>
                        <td>${formatCPF(v.cpf)}</td>
                        <td>${v.email}</td>
                        <td>${v.cidade}/${v.estado}</td>
                    </tr>`).join('')}
                    ${validos.length > 20 ? `<tr><td colspan="4" style="text-align:center;color:var(--text-secondary)">... e mais ${validos.length - 20} colaboradores</td></tr>` : ''}
                </tbody>
            `;
            document.getElementById('btnConfirmarImport').style.display = 'inline-flex';
        } else {
            document.getElementById('importPreview').innerHTML = '<tr><td style="padding:20px;text-align:center;color:var(--danger)">Nenhum registro v√°lido para importar</td></tr>';
        }
        
    } catch(err){
        console.error(err);
        alert('Erro ao processar arquivo: ' + err.message);
    }
}

async function confirmarImportacao(){
    if(!dadosImportacao.length){
        alert('Nenhum dado para importar!');
        return;
    }
    
    if(!confirm(`Confirma a importa√ß√£o de ${dadosImportacao.length} colaboradores?\n\nSenhas ser√£o geradas automaticamente.`)) return;
    
    document.getElementById('btnConfirmarImport').disabled = true;
    document.getElementById('btnConfirmarImport').textContent = 'Importando...';
    
    const d = await api('/admin/colaboradores/importar', {
        method: 'POST',
        body: JSON.stringify({ colaboradores: dadosImportacao })
    });
    
    document.getElementById('importEtapa2').style.display = 'none';
    document.getElementById('importEtapa3').style.display = 'block';
    document.getElementById('btnConfirmarImport').style.display = 'none';
    
    if(d && d.sucesso){
        document.getElementById('importResultado').innerHTML = `
            <div style="text-align:center;padding:20px">
                <div style="width:64px;height:64px;background:#d1fae5;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
                <h3 style="color:#059669;margin-bottom:8px">Importa√ß√£o Conclu√≠da!</h3>
                <p style="color:var(--text-secondary);margin-bottom:24px">${d.importados} colaboradores importados com sucesso.</p>
                ${d.erros && d.erros.length ? `
                    <div style="background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:12px;text-align:left;margin-bottom:16px">
                        <p style="font-size:13px;font-weight:600;color:#dc2626;margin-bottom:8px">${d.erros.length} erros durante a importa√ß√£o:</p>
                        ${d.erros.slice(0, 5).map(e => `<p style="font-size:12px;color:#dc2626">‚Ä¢ ${e}</p>`).join('')}
                    </div>
                ` : ''}
                ${d.senhas && d.senhas.length ? `
                    <div style="background:#fffbeb;border:1px solid #fcd34d;border-radius:8px;padding:12px;text-align:left">
                        <p style="font-size:13px;font-weight:600;color:#92400e;margin-bottom:8px">‚ö†Ô∏è Senhas geradas (anote-as!):</p>
                        <div style="max-height:150px;overflow-y:auto">
                            ${d.senhas.map(s => `<p style="font-size:12px;font-family:monospace">${s.nome}: <strong>${s.senha}</strong></p>`).join('')}
                        </div>
                        <button class="btn btn-sm btn-outline" style="margin-top:12px" onclick="exportarSenhasImportadas()">Exportar Senhas (Excel)</button>
                    </div>
                ` : ''}
            </div>
        `;
        
        // Salvar senhas para exporta√ß√£o
        if(d.senhas) window.senhasImportadas = d.senhas;
        
        loadColabs();
    } else {
        document.getElementById('importResultado').innerHTML = `
            <div style="text-align:center;padding:20px">
                <div style="width:64px;height:64px;background:#fee2e2;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                </div>
                <h3 style="color:#dc2626;margin-bottom:8px">Erro na Importa√ß√£o</h3>
                <p style="color:var(--text-secondary)">${d?.erro || 'Erro desconhecido'}</p>
            </div>
        `;
    }
}

function exportarSenhasImportadas(){
    if(!window.senhasImportadas || !window.senhasImportadas.length){
        alert('Nenhuma senha para exportar');
        return;
    }

    const ws = XLSX.utils.json_to_sheet(window.senhasImportadas.map(s => ({
        'Nome': s.nome,
        'CPF': s.cpf,
        'Email': s.email,
        'Senha': s.senha
    })));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Senhas');
    XLSX.writeFile(wb, `senhas_importacao_${new Date().toISOString().split('T')[0]}.xlsx`);
}

// ==================== IMPORTA√á√ÉO DE DISTRIBUIDORES ====================
let dadosImportacaoDist = [];

function abrirModalImportarDist(){
    document.getElementById('importDistEtapa1').style.display = 'block';
    document.getElementById('importDistEtapa2').style.display = 'none';
    document.getElementById('importDistEtapa3').style.display = 'none';
    document.getElementById('btnConfirmarImportDist').style.display = 'none';
    document.getElementById('arquivoImportDist').value = '';
    dadosImportacaoDist = [];

    document.getElementById('modalImportDist').classList.add('show');
}

function baixarModeloImportDist(){
    const modelo = [
        {
            nome: 'Distribuidora Exemplo',
            cnpj: '12345678000199',
            email: 'contato@distribuidora.com',
            telefone: '11999998888',
            responsavel: 'Jos√© da Silva',
            cidade: 'S√£o Paulo',
            estado: 'SP',
            tipo_distribuidor: 'externo'
        },
        {
            nome: 'Gas Center LTDA',
            cnpj: '98765432000188',
            email: 'gascenter@email.com',
            telefone: '11988887777',
            responsavel: 'Maria Santos',
            cidade: 'Campinas',
            estado: 'SP',
            tipo_distribuidor: 'interno'
        }
    ];

    const ws = XLSX.utils.json_to_sheet(modelo);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Distribuidores');

    ws['!cols'] = [
        {wch: 30}, {wch: 18}, {wch: 30}, {wch: 14},
        {wch: 25}, {wch: 20}, {wch: 5}, {wch: 12}
    ];

    XLSX.writeFile(wb, 'modelo_importacao_distribuidores.xlsx');
}

async function processarArquivoImportDist(input){
    const file = input.files[0];
    if(!file) return;

    try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(sheet);

        if(!jsonData.length){
            alert('Arquivo vazio ou formato inv√°lido!');
            return;
        }

        const camposObrigatorios = ['nome', 'cnpj', 'email', 'telefone', 'responsavel', 'cidade', 'estado'];
        const erros = [];
        const validos = [];

        jsonData.forEach((row, idx) => {
            const linha = idx + 2;
            const errosLinha = [];

            camposObrigatorios.forEach(campo => {
                if(!row[campo] || String(row[campo]).trim() === ''){
                    errosLinha.push(`${campo} vazio`);
                }
            });

            // Validar CNPJ (apenas n√∫meros, 14 d√≠gitos)
            if(row.cnpj){
                const cnpjLimpo = String(row.cnpj).replace(/\D/g, '');
                if(cnpjLimpo.length !== 14){
                    errosLinha.push('CNPJ inv√°lido (deve ter 14 d√≠gitos)');
                }
                row.cnpj = cnpjLimpo;
            }

            // Validar email
            if(row.email && !row.email.includes('@')){
                errosLinha.push('Email inv√°lido');
            }

            // Validar estado (2 letras)
            if(row.estado && row.estado.length !== 2){
                errosLinha.push('Estado deve ter 2 letras');
            }

            // Formatar telefone
            if(row.telefone){
                row.telefone = String(row.telefone).replace(/\D/g, '');
            }

            // Validar tipo_distribuidor
            if(row.tipo_distribuidor && !['interno', 'externo'].includes(row.tipo_distribuidor.toLowerCase())){
                errosLinha.push('tipo_distribuidor deve ser "interno" ou "externo"');
            } else if(row.tipo_distribuidor){
                row.tipo_distribuidor = row.tipo_distribuidor.toLowerCase();
            } else {
                row.tipo_distribuidor = 'externo'; // padr√£o
            }

            if(errosLinha.length > 0){
                erros.push({ linha, erros: errosLinha, dados: row });
            } else {
                validos.push(row);
            }
        });

        dadosImportacaoDist = validos;

        document.getElementById('importDistEtapa1').style.display = 'none';
        document.getElementById('importDistEtapa2').style.display = 'block';

        document.getElementById('importDistResumo').innerHTML = `
            <div style="display:flex;gap:16px;margin-bottom:16px">
                <div style="background:#d1fae5;padding:12px 20px;border-radius:8px;flex:1;text-align:center">
                    <p style="font-size:24px;font-weight:700;color:#059669">${validos.length}</p>
                    <p style="font-size:12px;color:#059669">V√°lidos</p>
                </div>
                <div style="background:${erros.length ? '#fee2e2' : '#f3f4f6'};padding:12px 20px;border-radius:8px;flex:1;text-align:center">
                    <p style="font-size:24px;font-weight:700;color:${erros.length ? '#dc2626' : '#6b7280'}">${erros.length}</p>
                    <p style="font-size:12px;color:${erros.length ? '#dc2626' : '#6b7280'}">Com erros</p>
                </div>
            </div>
            ${erros.length ? `
                <div style="background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:12px;margin-bottom:16px">
                    <p style="font-size:13px;font-weight:600;color:#dc2626;margin-bottom:8px">‚ö†Ô∏è Linhas com erro (ser√£o ignoradas):</p>
                    ${erros.slice(0, 5).map(e => `<p style="font-size:12px;color:#dc2626">Linha ${e.linha}: ${e.erros.join(', ')}</p>`).join('')}
                    ${erros.length > 5 ? `<p style="font-size:12px;color:#dc2626">... e mais ${erros.length - 5} erros</p>` : ''}
                </div>
            ` : ''}
        `;

        if(validos.length > 0){
            document.getElementById('importDistPreview').innerHTML = `
                <thead><tr><th>Nome</th><th>CNPJ</th><th>Email</th><th>Tipo</th></tr></thead>
                <tbody>${validos.slice(0, 20).map(v => `
                    <tr>
                        <td>${v.nome}</td>
                        <td>${formatCNPJ(v.cnpj)}</td>
                        <td>${v.email}</td>
                        <td><span class="badge ${v.tipo_distribuidor === 'interno' ? 'badge-info' : 'badge-success'}">${v.tipo_distribuidor}</span></td>
                    </tr>`).join('')}
                    ${validos.length > 20 ? `<tr><td colspan="4" style="text-align:center;color:var(--text-secondary)">... e mais ${validos.length - 20} distribuidores</td></tr>` : ''}
                </tbody>
            `;
            document.getElementById('btnConfirmarImportDist').style.display = 'inline-flex';
        } else {
            document.getElementById('importDistPreview').innerHTML = '<tr><td style="padding:20px;text-align:center;color:var(--danger)">Nenhum registro v√°lido para importar</td></tr>';
        }

    } catch(err){
        console.error(err);
        alert('Erro ao processar arquivo: ' + err.message);
    }
}

async function confirmarImportDist(){
    if(!dadosImportacaoDist.length){
        alert('Nenhum dado para importar!');
        return;
    }

    if(!confirm(`Confirma a importa√ß√£o de ${dadosImportacaoDist.length} distribuidores?\n\nSenhas ser√£o geradas automaticamente.`)) return;

    document.getElementById('btnConfirmarImportDist').disabled = true;
    document.getElementById('btnConfirmarImportDist').textContent = 'Importando...';

    const d = await api('/admin/distribuidores/importar', {
        method: 'POST',
        body: JSON.stringify({ distribuidores: dadosImportacaoDist })
    });

    document.getElementById('importDistEtapa2').style.display = 'none';
    document.getElementById('importDistEtapa3').style.display = 'block';
    document.getElementById('btnConfirmarImportDist').style.display = 'none';

    if(d && d.sucesso){
        document.getElementById('importDistResultado').innerHTML = `
            <div style="text-align:center;padding:20px">
                <div style="width:64px;height:64px;background:#d1fae5;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
                <h3 style="color:#059669;margin-bottom:8px">Importa√ß√£o Conclu√≠da!</h3>
                <p style="color:var(--text-secondary);margin-bottom:24px">${d.importados} distribuidores importados com sucesso.</p>
                ${d.erros && d.erros.length ? `
                    <div style="background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:12px;text-align:left;margin-bottom:16px">
                        <p style="font-size:13px;font-weight:600;color:#dc2626;margin-bottom:8px">${d.erros.length} erros durante a importa√ß√£o:</p>
                        ${d.erros.slice(0, 5).map(e => `<p style="font-size:12px;color:#dc2626">‚Ä¢ ${e}</p>`).join('')}
                    </div>
                ` : ''}
                ${d.senhas && d.senhas.length ? `
                    <div style="background:#fffbeb;border:1px solid #fcd34d;border-radius:8px;padding:12px;text-align:left">
                        <p style="font-size:13px;font-weight:600;color:#92400e;margin-bottom:8px">‚ö†Ô∏è Senhas geradas (anote-as!):</p>
                        <div style="max-height:150px;overflow-y:auto">
                            ${d.senhas.map(s => `<p style="font-size:12px;font-family:monospace">${s.nome}: <strong>${s.senha}</strong></p>`).join('')}
                        </div>
                        <button class="btn btn-sm btn-outline" style="margin-top:12px" onclick="exportarSenhasDistImportados()">Exportar Senhas (Excel)</button>
                    </div>
                ` : ''}
            </div>
        `;

        if(d.senhas) window.senhasDistImportados = d.senhas;

        loadDists();
    } else {
        document.getElementById('importDistResultado').innerHTML = `
            <div style="text-align:center;padding:20px">
                <div style="width:64px;height:64px;background:#fee2e2;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                </div>
                <h3 style="color:#dc2626;margin-bottom:8px">Erro na Importa√ß√£o</h3>
                <p style="color:var(--text-secondary)">${d?.erro || 'Erro desconhecido'}</p>
            </div>
        `;
    }

    document.getElementById('btnConfirmarImportDist').disabled = false;
    document.getElementById('btnConfirmarImportDist').textContent = 'Importar Distribuidores';
}

function exportarSenhasDistImportados(){
    if(!window.senhasDistImportados || !window.senhasDistImportados.length){
        alert('Nenhuma senha para exportar');
        return;
    }

    const ws = XLSX.utils.json_to_sheet(window.senhasDistImportados.map(s => ({
        'Nome': s.nome,
        'CNPJ': s.cnpj,
        'Email': s.email,
        'Senha': s.senha
    })));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Senhas');
    XLSX.writeFile(wb, `senhas_distribuidores_${new Date().toISOString().split('T')[0]}.xlsx`);
}

// ==================== NOTIFICA√á√ïES / WEBHOOKS ====================

async function loadWebhookStats(){
    const d = await api('/admin/webhooks/estatisticas?dias=30');
    if(!d || !d.dados) return;
    
    const stats = d.dados.stats;
    if(!stats || !stats.length){
        document.getElementById('statsWebhooks').innerHTML = '<div class="empty-state"><p>Nenhuma notifica√ß√£o enviada nos √∫ltimos 30 dias</p></div>';
        return;
    }
    
    // Calcular totais
    let totalEnvios = 0, totalSucessos = 0, totalFalhas = 0;
    stats.forEach(s => {
        totalEnvios += s.total;
        totalSucessos += s.sucessos;
        totalFalhas += s.falhas;
    });
    
    const taxaSucesso = totalEnvios > 0 ? ((totalSucessos / totalEnvios) * 100).toFixed(1) : 0;
    
    document.getElementById('statsWebhooks').innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:16px;margin-bottom:24px">
            <div style="background:var(--gray-50);padding:16px;border-radius:8px;text-align:center">
                <p style="font-size:28px;font-weight:700;color:var(--primary)">${totalEnvios}</p>
                <p style="font-size:12px;color:var(--text-secondary)">Total Enviados</p>
            </div>
            <div style="background:#d1fae5;padding:16px;border-radius:8px;text-align:center">
                <p style="font-size:28px;font-weight:700;color:#059669">${totalSucessos}</p>
                <p style="font-size:12px;color:#059669">Sucessos</p>
            </div>
            <div style="background:#fee2e2;padding:16px;border-radius:8px;text-align:center">
                <p style="font-size:28px;font-weight:700;color:#dc2626">${totalFalhas}</p>
                <p style="font-size:12px;color:#dc2626">Falhas</p>
            </div>
            <div style="background:#dbeafe;padding:16px;border-radius:8px;text-align:center">
                <p style="font-size:28px;font-weight:700;color:#2563eb">${taxaSucesso}%</p>
                <p style="font-size:12px;color:#2563eb">Taxa de Sucesso</p>
            </div>
        </div>
        <h4 style="font-size:14px;margin-bottom:12px;color:var(--gray-700)">Por Tipo de Notifica√ß√£o</h4>
        <table>
            <thead><tr><th>Tipo</th><th>Total</th><th>Sucesso</th><th>Falhas</th><th>Taxa</th></tr></thead>
            <tbody>${stats.map(s => `
                <tr>
                    <td><span class="badge badge-info">${formatTipoWebhook(s.tipo)}</span></td>
                    <td>${s.total}</td>
                    <td style="color:#059669">${s.sucessos}</td>
                    <td style="color:#dc2626">${s.falhas}</td>
                    <td>${s.total > 0 ? ((s.sucessos / s.total) * 100).toFixed(0) : 0}%</td>
                </tr>`).join('')}
            </tbody>
        </table>
    `;
}

function formatTipoWebhook(tipo){
    const map = {
        'codigo_gerado': 'C√≥digo Gerado',
        'lembrete_expiracao': 'Lembrete Expira√ß√£o',
        'vale_retirado': 'Vale Retirado',
        'senha_gerada': 'Senha Gerada',
        'senha_resetada': 'Senha Resetada',
        'recuperacao_senha': 'Recupera√ß√£o Senha'
    };
    return map[tipo] || tipo;
}

async function loadWebhookLogs(){
    const tipo = document.getElementById('webhookTipo').value;
    const sucesso = document.getElementById('webhookSucesso').value;
    
    let url = '/admin/webhooks/logs?limite=30';
    if(tipo) url += `&tipo=${tipo}`;
    if(sucesso !== '') url += `&sucesso=${sucesso}`;
    
    const d = await api(url);
    if(!d || !d.dados){
        document.getElementById('tableWebhookLogs').innerHTML = '<div class="empty-state"><p>Nenhum log encontrado</p></div>';
        return;
    }
    
    document.getElementById('tableWebhookLogs').innerHTML = d.dados.length ? `
        <table>
            <thead><tr><th style="width:140px">Data/Hora</th><th>Tipo</th><th>Destinat√°rio</th><th>Status</th></tr></thead>
            <tbody>${d.dados.map(l => `
                <tr>
                    <td style="font-size:12px">${new Date(l.criado_em).toLocaleString('pt-BR')}</td>
                    <td><span class="badge badge-info">${formatTipoWebhook(l.tipo)}</span></td>
                    <td style="font-size:12px">${l.payload?.destinatario?.nome || l.payload?.colaborador?.nome || '-'}</td>
                    <td>
                        <span class="badge ${l.sucesso ? 'badge-success' : 'badge-danger'}">
                            ${l.sucesso ? '‚úì Enviado' : '‚úó Falhou'}
                        </span>
                        ${!l.sucesso && l.status_code ? `<small style="color:var(--text-secondary)">(${l.status_code})</small>` : ''}
                    </td>
                </tr>`).join('')}
            </tbody>
        </table>
    ` : '<div class="empty-state"><p>Nenhum log encontrado</p></div>';
}

async function enviarLembretes(dias){
    if(!confirm(`Enviar lembretes para vales que expiram em ${dias.join(', ')} dias?\n\nIsso ir√° disparar notifica√ß√µes via webhook.`)) return;
    
    const d = await api('/admin/webhooks/enviar-lembretes', {
        method: 'POST',
        body: JSON.stringify({ dias })
    });
    
    if(d && d.sucesso){
        alert(`‚úÖ ${d.mensagem}`);
        loadWebhookStats();
        loadWebhookLogs();
    } else {
        alert(d?.erro || 'Erro ao enviar lembretes');
    }
}

// ==================== CONFIGURA√á√ïES ====================

async function loadConfiguracoes(){
    const d = await api('/admin/configuracoes');
    if(!d || !d.dados) return;
    
    // Preencher campos
    d.dados.forEach(config => {
        const campo = document.getElementById('cfg_' + config.chave);
        if(campo) campo.value = config.valor;
    });
}

async function salvarConfiguracoes(){
    const configs = [
        { chave: 'vales_por_mes', valor: document.getElementById('cfg_vales_por_mes').value },
        { chave: 'dias_validade_vale', valor: document.getElementById('cfg_dias_validade_vale').value },
        { chave: 'dia_geracao_automatica', valor: document.getElementById('cfg_dia_geracao_automatica').value },
        { chave: 'notificar_expiracao_dias', valor: document.getElementById('cfg_notificar_expiracao_dias').value }
    ];
    
    // Valida√ß√µes
    const valesPorMes = parseInt(configs[0].valor);
    if(isNaN(valesPorMes) || valesPorMes < 1 || valesPorMes > 10){
        alert('Vales por m√™s deve ser entre 1 e 10');
        return;
    }
    
    const diasValidade = parseInt(configs[1].valor);
    if(isNaN(diasValidade) || diasValidade < 1 || diasValidade > 90){
        alert('Dias de validade deve ser entre 1 e 90');
        return;
    }
    
    const diaGeracao = parseInt(configs[2].valor);
    if(isNaN(diaGeracao) || diaGeracao < 1 || diaGeracao > 28){
        alert('Dia de gera√ß√£o deve ser entre 1 e 28');
        return;
    }
    
    // Validar formato de dias de lembrete
    const diasLembrete = configs[3].valor;
    if(!/^(\d+,)*\d+$/.test(diasLembrete)){
        alert('Dias de lembrete devem ser n√∫meros separados por v√≠rgula (ex: 7,3,1)');
        return;
    }
    
    let erros = 0;
    for(const config of configs){
        const d = await api(`/admin/configuracoes/${config.chave}`, {
            method: 'PUT',
            body: JSON.stringify({ valor: config.valor })
        });
        if(!d || !d.sucesso) erros++;
    }
    
    if(erros === 0){
        alert('‚úÖ Configura√ß√µes salvas com sucesso!');
    } else {
        alert(`‚ö†Ô∏è ${erros} configura√ß√£o(√µes) n√£o puderam ser salvas`);
    }
}

// ==================== AUDITORIA ====================
let auditoriaPagina = 1;

// Mapeamento de cores por categoria de a√ß√£o
const acaoIcons = {
    // Login
    login: { icon: 'üîë', cor: '#22c55e' },
    logout: { icon: 'üö™', cor: '#64748b' },
    login_falha: { icon: 'üö´', cor: '#ef4444' },
    // Colaboradores
    criar_colaborador: { icon: 'üë§', cor: '#3b82f6' },
    editar_colaborador: { icon: '‚úèÔ∏è', cor: '#f59e0b' },
    ativar_colaborador: { icon: '‚úÖ', cor: '#22c55e' },
    desativar_colaborador: { icon: '‚ùå', cor: '#ef4444' },
    resetar_senha_colaborador: { icon: 'üîê', cor: '#8b5cf6' },
    // Distribuidores
    criar_distribuidor: { icon: 'üè™', cor: '#3b82f6' },
    editar_distribuidor: { icon: '‚úèÔ∏è', cor: '#f59e0b' },
    ativar_distribuidor: { icon: '‚úÖ', cor: '#22c55e' },
    desativar_distribuidor: { icon: '‚ùå', cor: '#ef4444' },
    resetar_senha_distribuidor: { icon: 'üîê', cor: '#8b5cf6' },
    // Vales
    gerar_vale: { icon: 'üé´', cor: '#3b82f6' },
    gerar_vales_mensal: { icon: 'üìã', cor: '#0ea5e9' },
    validar_vale: { icon: 'üîç', cor: '#64748b' },
    confirmar_retirada: { icon: '‚úÖ', cor: '#22c55e' },
    // Reembolsos
    criar_reembolso: { icon: 'üí∞', cor: '#3b82f6' },
    aprovar_reembolso: { icon: '‚úÖ', cor: '#22c55e' },
    rejeitar_reembolso: { icon: '‚ùå', cor: '#ef4444' },
    pagar_reembolso: { icon: 'üíµ', cor: '#10b981' },
    editar_reembolso: { icon: '‚úèÔ∏è', cor: '#f59e0b' },
    excluir_reembolso: { icon: 'üóëÔ∏è', cor: '#ef4444' },
    upload_documento: { icon: 'üìé', cor: '#8b5cf6' },
    // Usu√°rios
    criar_usuario: { icon: 'üëî', cor: '#3b82f6' },
    editar_usuario: { icon: '‚úèÔ∏è', cor: '#f59e0b' },
    ativar_usuario: { icon: '‚úÖ', cor: '#22c55e' },
    desativar_usuario: { icon: '‚ùå', cor: '#ef4444' },
    // Sistema
    alterar_configuracao: { icon: '‚öôÔ∏è', cor: '#64748b' },
    aprovar_solicitacao: { icon: '‚úÖ', cor: '#22c55e' },
    rejeitar_solicitacao: { icon: '‚ùå', cor: '#ef4444' }
};

async function loadAuditoria(pagina = 1){
    auditoriaPagina = pagina;
    const dataIni = document.getElementById('auditDataIni').value;
    const dataFim = document.getElementById('auditDataFim').value;
    const tipoUsuario = document.getElementById('auditTipoUsuario').value;
    const acao = document.getElementById('auditAcao').value;
    const busca = document.getElementById('auditBusca').value;

    let url = `/admin/auditoria?pagina=${pagina}&limite=30`;
    if(dataIni) url += `&data_inicio=${dataIni}`;
    if(dataFim) url += `&data_fim=${dataFim}`;
    if(tipoUsuario) url += `&tipo_usuario=${tipoUsuario}`;
    if(acao) url += `&acao=${acao}`;
    if(busca) url += `&busca=${encodeURIComponent(busca)}`;

    const d = await api(url);
    if(!d || !d.dados){
        document.getElementById('tableAuditoria').innerHTML = '<div class="empty-state"><p>Nenhum registro encontrado</p></div>';
        document.getElementById('paginacaoAuditoria').innerHTML = '';
        document.getElementById('auditTotal').textContent = '';
        return;
    }

    // Atualizar total
    document.getElementById('auditTotal').textContent = `${d.paginacao.total} registros encontrados`;

    const tipoBadge = {'admin':'badge-danger','colaborador':'badge-success','distribuidor':'badge-info'};
    const tipoNome = {'admin':'RH/Admin','colaborador':'Colaborador','distribuidor':'Distribuidor'};

    document.getElementById('tableAuditoria').innerHTML = d.dados.length ? `
        <table>
            <thead><tr>
                <th style="width:150px">Data/Hora</th>
                <th>Usu√°rio</th>
                <th style="width:100px">Tipo</th>
                <th>A√ß√£o</th>
                <th>Detalhes</th>
                <th style="width:100px">IP</th>
            </tr></thead>
            <tbody>${d.dados.map(l => {
                const acaoInfo = acaoIcons[l.acao] || { icon: 'üìù', cor: '#64748b' };
                return `
                <tr>
                    <td style="font-size:12px;white-space:nowrap">
                        <div style="color:var(--text-primary)">${new Date(l.criado_em).toLocaleDateString('pt-BR')}</div>
                        <div style="color:var(--text-secondary);font-size:11px">${new Date(l.criado_em).toLocaleTimeString('pt-BR')}</div>
                    </td>
                    <td><strong>${l.usuario_nome}</strong></td>
                    <td><span class="badge ${tipoBadge[l.tipo_usuario]}">${tipoNome[l.tipo_usuario] || l.tipo_usuario}</span></td>
                    <td>
                        <div style="display:flex;align-items:center;gap:8px">
                            <span style="font-size:16px">${acaoInfo.icon}</span>
                            <span style="color:${acaoInfo.cor};font-weight:500">${l.acao_descricao || l.acao}</span>
                        </div>
                    </td>
                    <td style="font-size:12px;color:var(--text-secondary)">${formatDetalhes(l)}</td>
                    <td style="font-size:11px;color:var(--gray-400);font-family:monospace">${l.ip || '-'}</td>
                </tr>`}).join('')}
            </tbody>
        </table>
    ` : '<div class="empty-state"><p>Nenhum registro encontrado</p></div>';

    // Pagina√ß√£o
    const pg = d.paginacao;
    if(pg.total_paginas > 1){
        let btns = '';
        if(pg.pagina > 1) btns += `<button class="btn btn-sm btn-outline" onclick="loadAuditoria(${pg.pagina - 1})">‚Üê Anterior</button>`;
        btns += `<span style="padding:8px 12px;font-size:13px">P√°gina ${pg.pagina} de ${pg.total_paginas}</span>`;
        if(pg.pagina < pg.total_paginas) btns += `<button class="btn btn-sm btn-outline" onclick="loadAuditoria(${pg.pagina + 1})">Pr√≥xima ‚Üí</button>`;
        document.getElementById('paginacaoAuditoria').innerHTML = btns;
    } else {
        document.getElementById('paginacaoAuditoria').innerHTML = '';
    }

    // Carregar estat√≠sticas
    loadAuditoriaStats();
}

async function loadAuditoriaStats(){
    try {
        const d = await api('/admin/auditoria/estatisticas');
        if(!d || !d.dados) return;

        // A√ß√µes hoje
        const hoje = new Date().toISOString().split('T')[0];
        const acoesHoje = d.dados.acoes_por_dia.find(a => a.data === hoje);
        document.getElementById('auditHoje').textContent = acoesHoje ? acoesHoje.total : '0';

        // Logins (soma dos √∫ltimos 7 dias)
        const totalLogins = d.dados.logins_por_tipo.reduce((acc, l) => acc + l.total, 0);
        document.getElementById('auditLogins').textContent = totalLogins;

        // Reembolsos processados
        const reembAcoes = ['aprovar_reembolso', 'pagar_reembolso', 'rejeitar_reembolso'];
        const totalReemb = d.dados.acoes_por_tipo.filter(a => reembAcoes.includes(a.acao)).reduce((acc, a) => acc + a.total, 0);
        document.getElementById('auditReembolsos').textContent = totalReemb;

        // Vales gerados
        const valesAcoes = ['gerar_vale', 'gerar_vales_mensal'];
        const totalVales = d.dados.acoes_por_tipo.filter(a => valesAcoes.includes(a.acao)).reduce((acc, a) => acc + a.total, 0);
        document.getElementById('auditVales').textContent = totalVales;

    } catch(e) {
        console.error('Erro ao carregar estat√≠sticas de auditoria:', e);
    }
}

function limparFiltrosAuditoria(){
    document.getElementById('auditDataIni').value = '';
    document.getElementById('auditDataFim').value = '';
    document.getElementById('auditTipoUsuario').value = '';
    document.getElementById('auditAcao').value = '';
    document.getElementById('auditBusca').value = '';
    loadAuditoria(1);
}

function formatDetalhes(log){
    if(!log.detalhes) {
        if(log.entidade && log.entidade_id) return `<code style="background:var(--bg-secondary);padding:2px 6px;border-radius:4px">${log.entidade} #${log.entidade_id}</code>`;
        return '-';
    }
    const d = log.detalhes;

    // Nome do colaborador/distribuidor
    if(d.nome) return d.nome;

    // Motivo de rejei√ß√£o
    if(d.motivo) return `<span style="color:var(--danger)">${d.motivo}</span>`;

    // Vales gerados
    if(d.gerados) return `<span style="color:var(--success)">${d.gerados} vales gerados</span>`;

    // Valor de reembolso
    if(d.valor) return `<span style="color:var(--primary)">R$ ${parseFloat(d.valor).toFixed(2)}</span>`;

    // Arquivos
    if(d.arquivos) return `<span style="color:var(--info)">Arquivos: ${d.arquivos.join(', ')}</span>`;

    // Vale e colaborador
    if(d.vale_id) return `<code style="background:var(--bg-secondary);padding:2px 6px;border-radius:4px">Vale #${d.vale_id}</code>`;

    // Gen√©rico
    const str = JSON.stringify(d);
    return str.length > 60 ? str.substring(0, 60) + '...' : str;
}

// Masks
document.getElementById('cCpf').addEventListener('input',function(e){
    let v=e.target.value.replace(/\D/g,'');
    v=v.replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d{1,2})$/,'$1-$2');
    e.target.value=v;
});
document.getElementById('dCnpj').addEventListener('input',function(e){
    let v=e.target.value.replace(/\D/g,'');
    v=v.replace(/(\d{2})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1.$2').replace(/(\d{3})(\d)/,'$1/$2').replace(/(\d{4})(\d{1,2})$/,'$1-$2');
    e.target.value=v;
});

// Init
loadDash();

// ========================================
// GEST√ÉO DE REEMBOLSOS
// ========================================
let reembolsoAtual = null;
let valesPendentesLista = [];
let valesSelecionados = new Set();

function formatarMesRef(mesRef) {
    if (!mesRef) return '-';
    const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
    const partes = mesRef.split('-');
    if (partes.length !== 2) return mesRef;
    return `${meses[parseInt(partes[1]) - 1]}/${partes[0]}`;
}

function badgeStatus(status) {
    const b = {'a_validar':'badge-warning','aprovado':'badge-info','pago':'badge-success','rejeitado':'badge-danger'};
    const t = {'a_validar':'A Validar','aprovado':'Aprovado','pago':'Pago','rejeitado':'Rejeitado'};
    return `<span class="badge ${b[status]||'badge-secondary'}">${t[status]||status}</span>`;
}

async function loadReembolsos() {
    const status = document.getElementById('filtro-status-reembolso')?.value || '';
    const distribuidor = document.getElementById('filtro-distribuidor-reembolso')?.value || '';
    const mes = document.getElementById('filtro-mes-reembolso')?.value || '';

    const params = new URLSearchParams({limit: 100});
    if(status) params.append('status', status);
    if(distribuidor) params.append('distribuidor_id', distribuidor);
    if(mes) params.append('mes_referencia', mes);

    const d = await api(`/admin/reembolsos?${params}`);
    if(!d) return;

    // Atualizar estat√≠sticas
    if(d.stats) {
        document.getElementById('reembolsos-a-validar').textContent = d.stats.a_validar || 0;
        document.getElementById('reembolsos-aprovados').textContent = d.stats.aprovado || 0;
        document.getElementById('reembolsos-pagos').textContent = d.stats.pago || 0;
        document.getElementById('reembolsos-total').textContent = 'R$ ' + (parseFloat(d.stats.valor_aprovado) || 0).toFixed(2).replace('.', ',');
    }

    if(!d.data || d.data.length === 0) {
        document.getElementById('tableReembolsos').innerHTML = '<div class="empty-state"><p>Nenhum reembolso encontrado</p></div>';
        return;
    }

    document.getElementById('tableReembolsos').innerHTML = `
        <table>
            <thead><tr><th>ID</th><th>Distribuidor</th><th>Colaborador</th><th>Vale</th><th>M√™s</th><th>Valor</th><th>Status</th><th>A√ß√µes</th></tr></thead>
            <tbody>${d.data.map(r => `
                <tr>
                    <td>${r.id}</td>
                    <td><strong>${r.distribuidor_nome||'-'}</strong><br><small style="color:var(--text-secondary)">${r.distribuidor_cnpj||''}</small></td>
                    <td><strong>${r.colaborador_nome||'-'}</strong><br><small style="color:var(--text-secondary)">${r.colaborador_cpf||''}</small></td>
                    <td><code style="background:var(--gray-100);padding:2px 6px;border-radius:4px">${r.codigo_vale||'-'}</code></td>
                    <td>${formatarMesRef(r.mes_referencia)}</td>
                    <td style="font-weight:600;color:var(--success)">R$ ${parseFloat(r.valor).toFixed(2).replace('.', ',')}</td>
                    <td>${badgeStatus(r.status)}</td>
                    <td><button class="btn btn-sm btn-outline" onclick="verReembolso(${r.id})">Ver</button></td>
                </tr>`).join('')}
            </tbody>
        </table>`;
}

async function carregarDistribuidoresFiltro() {
    const d = await api('/admin/distribuidores?ativo=true&limite=1000');
    if(d?.dados) {
        const sel = document.getElementById('filtro-distribuidor-reembolso');
        sel.innerHTML = '<option value="">Todos Distribuidores</option>' +
            d.dados.map(x => `<option value="${x.id}">${x.nome}</option>`).join('');
    }
}

function limparFiltrosReembolsos() {
    document.getElementById('filtro-status-reembolso').value = '';
    document.getElementById('filtro-distribuidor-reembolso').value = '';
    document.getElementById('filtro-mes-reembolso').value = '';
    loadReembolsos();
}

async function verReembolso(id) {
    const d = await api(`/admin/reembolsos/${id}`);
    if(!d?.data) return;

    reembolsoAtual = d.data;
    document.getElementById('det-reembolso-id').textContent = d.data.id;
    document.getElementById('det-distribuidor').textContent = d.data.distribuidor_nome || '-';
    document.getElementById('det-cnpj').textContent = d.data.distribuidor_cnpj || '-';
    document.getElementById('det-colaborador').textContent = d.data.colaborador_nome || '-';
    document.getElementById('det-cpf').textContent = d.data.colaborador_cpf || '-';
    document.getElementById('det-codigo-vale').textContent = d.data.codigo_vale || '-';
    document.getElementById('det-mes-ref').textContent = formatarMesRef(d.data.mes_referencia);
    document.getElementById('det-valor').textContent = 'R$ ' + parseFloat(d.data.valor).toFixed(2).replace('.', ',');
    document.getElementById('det-status').innerHTML = badgeStatus(d.data.status);
    document.getElementById('det-banco').textContent = d.data.banco || '-';
    document.getElementById('det-agencia').textContent = d.data.agencia || '-';
    document.getElementById('det-conta').textContent = d.data.conta || '-';
    document.getElementById('det-tipo-conta').textContent = d.data.tipo_conta || '-';
    document.getElementById('det-pix').textContent = d.data.pix || '-';

    if(d.data.observacoes) {
        document.getElementById('det-observacoes').textContent = d.data.observacoes;
        document.getElementById('det-observacoes-container').style.display = 'block';
    } else {
        document.getElementById('det-observacoes-container').style.display = 'none';
    }

    // Atualizar status dos documentos
    atualizarStatusDocumento('nf', d.data.comprovante_nf);
    atualizarStatusDocumento('recibo', d.data.comprovante_recibo);

    // Bot√µes de a√ß√£o baseados no status
    let acoes = '<button type="button" class="btn btn-outline" onclick="closeModal(\'reembolso\')">Fechar</button>';
    if(d.data.status === 'a_validar') {
        acoes += '<button type="button" class="btn btn-success" onclick="abrirModalAprovar()">Aprovar</button>';
        acoes += '<button type="button" class="btn btn-danger" onclick="abrirModalRejeitar()">Rejeitar</button>';
    } else if(d.data.status === 'aprovado') {
        acoes += '<button type="button" class="btn btn-success" onclick="abrirModalMarcarPago()">Marcar Pago</button>';
    }
    document.getElementById('acoesReembolso').innerHTML = acoes;

    abrirModalPorId('modalReembolso');
}

function abrirModalAprovar() {
    // Verificar se h√° documentos anexados
    if(!reembolsoAtual.comprovante_nf && !reembolsoAtual.comprovante_recibo) {
        alert('√â necess√°rio anexar a Nota Fiscal ou Recibo antes de aprovar o reembolso.\n\nAnexe o documento na se√ß√£o "Documentos" e tente novamente.');
        return;
    }
    document.getElementById('aprovar-observacoes').value = '';
    abrirModalPorId('modalAprovarReembolso');
}

function abrirModalRejeitar() {
    document.getElementById('rejeitar-motivo').value = '';
    abrirModalPorId('modalRejeitarReembolso');
}

function abrirModalMarcarPago() {
    document.getElementById('pago-observacoes').value = '';
    abrirModalPorId('modalMarcarPago');
}

// Fun√ß√µes para gerenciar documentos do reembolso
function atualizarStatusDocumento(tipo, arquivo) {
    const statusEl = document.getElementById(`det-${tipo}-status`);
    const previewEl = document.getElementById(`det-${tipo}-preview`);
    const linkEl = document.getElementById(`det-${tipo}-link`);

    if(arquivo) {
        statusEl.className = 'badge badge-success';
        statusEl.textContent = 'Anexado';
        previewEl.style.display = 'block';
        linkEl.href = `/api/admin/reembolsos/${reembolsoAtual.id}/arquivo/${tipo}?token=${token}`;
    } else {
        statusEl.className = 'badge badge-warning';
        statusEl.textContent = 'Pendente';
        previewEl.style.display = 'none';
    }
}

async function uploadArquivoReembolso(tipo) {
    const inputId = tipo === 'nf' ? 'uploadNF' : 'uploadRecibo';
    const input = document.getElementById(inputId);
    const file = input.files[0];

    if(!file || !reembolsoAtual) return;

    // Validar tamanho (max 10MB)
    if(file.size > 10 * 1024 * 1024) {
        alert('Arquivo muito grande. M√°ximo: 10MB');
        input.value = '';
        return;
    }

    const formData = new FormData();
    formData.append(tipo === 'nf' ? 'comprovante_nf' : 'comprovante_recibo', file);

    try {
        const response = await fetch(`${API}/admin/reembolsos/${reembolsoAtual.id}/upload`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token
            },
            body: formData
        });

        const result = await response.json();

        if(result.success) {
            alert('Arquivo enviado com sucesso!');
            // Atualizar visualiza√ß√£o
            atualizarStatusDocumento(tipo, file.name);
            // Atualizar objeto local
            if(tipo === 'nf') reembolsoAtual.comprovante_nf = result.arquivo;
            else reembolsoAtual.comprovante_recibo = result.arquivo;
        } else {
            alert(result.error || 'Erro ao enviar arquivo');
        }
    } catch(err) {
        alert('Erro ao enviar arquivo: ' + err.message);
    }

    input.value = '';
}

async function confirmarAprovacao(e) {
    e.preventDefault();
    if(!reembolsoAtual) return;

    const d = await api(`/admin/reembolsos/${reembolsoAtual.id}/aprovar`, {
        method: 'POST',
        body: JSON.stringify({
            observacoes: document.getElementById('aprovar-observacoes').value
        })
    });

    if(d?.success) {
        closeModal('aprovarReembolso');
        closeModal('reembolso');
        loadReembolsos();
        alert('Reembolso aprovado com sucesso!');
    } else {
        alert(d?.error || 'Erro ao aprovar reembolso');
    }
}

async function confirmarRejeicao(e) {
    e.preventDefault();
    if(!reembolsoAtual) return;

    const motivo = document.getElementById('rejeitar-motivo').value;
    if(!motivo.trim()) {
        alert('Informe o motivo da rejei√ß√£o');
        return;
    }

    const d = await api(`/admin/reembolsos/${reembolsoAtual.id}/rejeitar`, {
        method: 'POST',
        body: JSON.stringify({
            motivo_rejeicao: motivo
        })
    });

    if(d?.success) {
        closeModal('rejeitarReembolso');
        closeModal('reembolso');
        loadReembolsos();
        alert('Reembolso rejeitado');
    } else {
        alert(d?.error || 'Erro ao rejeitar reembolso');
    }
}

async function confirmarPagamento(e) {
    e.preventDefault();
    if(!reembolsoAtual) return;

    const d = await api(`/admin/reembolsos/${reembolsoAtual.id}/marcar-pago`, {
        method: 'POST',
        body: JSON.stringify({
            observacoes: document.getElementById('pago-observacoes').value
        })
    });

    if(d?.success) {
        closeModal('marcarPago');
        closeModal('reembolso');
        loadReembolsos();
        alert('Reembolso marcado como pago!');
    } else {
        alert(d?.error || 'Erro ao marcar como pago');
    }
}

async function abrirModalNovoReembolso() {
    valesPendentesLista = [];
    valesSelecionados.clear();
    document.getElementById('novo-reembolso-distribuidor').value = '';
    document.getElementById('vales-pendentes-container').style.display = 'none';
    document.getElementById('resumo-selecao').style.display = 'none';
    document.getElementById('btn-criar-reembolsos').disabled = true;
    document.getElementById('novo-observacoes').value = '';

    // Carregar distribuidores externos
    const d = await api('/admin/distribuidores?ativo=true&tipo=externo&limite=1000');
    const sel = document.getElementById('novo-reembolso-distribuidor');
    sel.innerHTML = '<option value="">Selecione um distribuidor...</option>';
    if(d?.dados) {
        d.dados.forEach(x => {
            sel.innerHTML += `<option value="${x.id}">${x.nome} - ${x.cnpj}</option>`;
        });
    }

    abrirModalPorId('modalNovoReembolso');
}

async function carregarValesPendentes() {
    const distribuidorId = document.getElementById('novo-reembolso-distribuidor').value;
    const container = document.getElementById('vales-pendentes-container');
    const tabela = document.getElementById('tabela-vales-pendentes');

    if(!distribuidorId) {
        container.style.display = 'none';
        return;
    }

    container.style.display = 'block';
    tabela.innerHTML = '<div style="text-align:center;padding:20px">Carregando...</div>';

    const d = await api(`/admin/reembolsos/vales-pendentes/${distribuidorId}`);

    if(!d?.vales || d.vales.length === 0) {
        tabela.innerHTML = '<div class="empty-state"><p>Nenhum vale pendente de reembolso para este distribuidor</p></div>';
        document.getElementById('resumo-selecao').style.display = 'none';
        return;
    }

    valesPendentesLista = d.vales;
    valesSelecionados.clear();

    tabela.innerHTML = `
        <table>
            <thead><tr>
                <th style="width:40px"><input type="checkbox" id="selecionar-todos" onchange="toggleSelecionarTodos()"></th>
                <th>C√≥digo</th><th>Colaborador</th><th>M√™s</th><th>Valor</th>
            </tr></thead>
            <tbody>${d.vales.map(v => `
                <tr>
                    <td><input type="checkbox" class="vale-cb" data-id="${v.id}" data-valor="${v.valor||0}" onchange="toggleVale(${v.id})"></td>
                    <td><code style="background:var(--gray-100);padding:2px 6px;border-radius:4px">${v.codigo}</code></td>
                    <td>${v.colaborador_nome||'-'}</td>
                    <td>${formatarMesRef(v.mes_referencia)}</td>
                    <td style="font-weight:600;color:var(--success)">R$ ${(parseFloat(v.valor)||0).toFixed(2).replace('.', ',')}</td>
                </tr>`).join('')}
            </tbody>
        </table>`;

    atualizarResumoSelecao();
}

function toggleVale(valeId) {
    if(valesSelecionados.has(valeId)) {
        valesSelecionados.delete(valeId);
    } else {
        valesSelecionados.add(valeId);
    }
    atualizarResumoSelecao();
}

function toggleSelecionarTodos() {
    const checked = document.getElementById('selecionar-todos').checked;
    valesSelecionados.clear();
    document.querySelectorAll('.vale-cb').forEach(cb => {
        cb.checked = checked;
        if(checked) valesSelecionados.add(parseInt(cb.dataset.id));
    });
    atualizarResumoSelecao();
}

function atualizarResumoSelecao() {
    const resumo = document.getElementById('resumo-selecao');
    const btn = document.getElementById('btn-criar-reembolsos');

    if(valesSelecionados.size === 0) {
        resumo.style.display = 'none';
        btn.disabled = true;
        return;
    }

    let total = 0;
    valesPendentesLista.forEach(v => {
        if(valesSelecionados.has(v.id)) total += parseFloat(v.valor) || 0;
    });

    document.getElementById('qtd-vales-selecionados').textContent = valesSelecionados.size;
    document.getElementById('total-reembolso').textContent = total.toFixed(2).replace('.', ',');
    resumo.style.display = 'block';
    btn.disabled = false;
}

async function criarReembolsosSelecionados() {
    if(valesSelecionados.size === 0) return;

    const distribuidorId = document.getElementById('novo-reembolso-distribuidor').value;
    const observacoes = document.getElementById('novo-observacoes').value;
    const btn = document.getElementById('btn-criar-reembolsos');

    btn.disabled = true;
    btn.textContent = 'Criando...';

    let criados = 0;
    for(const vale of valesPendentesLista) {
        if(!valesSelecionados.has(vale.id)) continue;

        const d = await api('/admin/reembolsos', {
            method: 'POST',
            body: JSON.stringify({
                vale_id: vale.id,
                distribuidor_id: parseInt(distribuidorId),
                colaborador_id: vale.colaborador_id,
                valor: parseFloat(vale.valor) || 0,
                mes_referencia: vale.mes_referencia,
                observacoes
            })
        });

        if(d?.success) criados++;
    }

    btn.disabled = false;
    btn.textContent = 'Criar Reembolso(s)';

    if(criados > 0) {
        alert(`${criados} reembolso(s) criado(s) com sucesso!`);
        closeModal('novoReembolso');
        loadReembolsos();
    }
}

async function exportarReembolsosCSV() {
    const status = document.getElementById('filtro-status-reembolso')?.value || '';
    const distribuidor = document.getElementById('filtro-distribuidor-reembolso')?.value || '';
    const mes = document.getElementById('filtro-mes-reembolso')?.value || '';

    const params = new URLSearchParams();
    if(status) params.append('status', status);
    if(distribuidor) params.append('distribuidor_id', distribuidor);
    if(mes) params.append('mes_referencia', mes);

    window.open(`/api/admin/reembolsos/exportar/csv?${params}&token=${token}`, '_blank');
}

</script>

</body>
</html>
